<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro de Comida - PostgreSQL</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tone.js para sonidos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <!-- Socket.IO -->
    <!-- Socket.IO -->
    <!-- Usamos ruta relativa del servidor para evitar problemas de CDN externo -->
    <script src="/socket.io/socket.io.js"></script>

    <!-- html2canvas para descargar gafete -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- SheetJS para Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- JSZip para comprimir archivos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- Thermal Printer Encoder para impresión USB -->
    <script src="https://unpkg.com/thermal-printer-encoder@latest/dist/thermal-printer-encoder.umd.js"></script>

    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="styles.css">
</head>

<body class="bg-gray-100">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-[200] flex items-center justify-center">
        <div class="text-xl font-bold text-gray-700">Cargando sistema...</div>
    </div>

    <!-- PÁGINA DE LOGIN -->
    <div id="login-page"
        class="page-container hidden flex items-center justify-center p-4 min-h-screen bg-gradient-to-br from-blue-500 to-purple-600">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <img src="https://i.imgur.com/4SmaZVt.png" crossorigin="anonymous" alt="Logo"
                    class="mx-auto h-32 w-auto mb-4">
                <h1 class="text-3xl font-bold text-gray-800">Sistema de Comedor</h1>
                <p class="text-gray-500 mt-2">Inicie sesión para continuar</p>
            </div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-gray-700 text-sm font-bold mb-2">
                        Correo Electrónico
                    </label>
                    <input type="email" id="login-email" required
                        class="shadow-inner appearance-none border-2 border-gray-200 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="usuario@ejemplo.com">
                </div>

                <div>
                    <label for="login-password" class="block text-gray-700 text-sm font-bold mb-2">
                        Contraseña
                    </label>
                    <input type="password" id="login-password" required
                        class="shadow-inner appearance-none border-2 border-gray-200 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="••••••••">
                </div>

                <div id="login-error"
                    class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm">
                </div>

                <button type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transform hover:scale-105 transition-transform duration-200">
                    Iniciar Sesión
                </button>
            </form>

            <div class="mt-6 text-center text-sm text-gray-600">
                <p>Usuario de prueba: <strong>admin@comedor.com</strong></p>
            </div>
        </div>
    </div>

    <!-- PÁGINA PRINCIPAL: REGISTRO -->
    <div id="main-page" class="page-container flex items-center justify-center p-4 min-h-screen relative">
        <!-- Información del usuario (solo visible para usuarios no admin) -->
        <div id="user-info-badge" class="fixed top-4 left-4 bg-white text-gray-800 py-2 px-4 rounded-lg shadow-lg z-30">
            <div class="flex items-center gap-2 mb-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <span id="user-name-display" class="font-semibold">Usuario</span>
            </div>
            <div class="flex items-center gap-2 text-sm text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-600" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
                <span id="comedor-name-display">Comedor</span>
            </div>
        </div>

        <!-- Botón Cerrar Sesión (solo visible para usuarios no admin) -->
        <button id="logout-button-main"
            class="fixed top-4 right-4 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg z-30 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            Cerrar Sesión
        </button>

        <!-- Botón Conectar Impresora BT -->
        <div class="fixed top-4 right-44 z-30">
            <div class="flex items-center space-x-2">
                <button id="connect-printer-button"
                    class="bg-blue-800 hover:bg-blue-900 text-white font-bold py-2 px-4 rounded-lg shadow-lg flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </svg>
                    <span id="printer-status-text">Conectar Impresora</span>
                </button>
                <!--
                <button onclick="document.getElementById('driver-help-modal').classList.remove('hidden')"
                    class="text-blue-600 hover:text-blue-800 text-sm underline">
                    ¿Problemas de conexión?
                </button>
                -->
            </div>
        </div>

        <!-- Driver Help Modal -->
        <div id="driver-help-modal"
            class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
                <div class="mt-3">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 border-b pb-2 mb-4">Instalación de Driver
                        para Impresora Térmica</h3>
                    <div class="mt-2 text-left space-y-4">
                        <div class="bg-yellow-50 p-4 rounded border border-yellow-200">
                            <p class="text-sm text-yellow-800">
                                <strong>IMPORTANTE:</strong> Windows requiere cambiar el driver de la impresora a
                                <strong>WinUSB</strong> para que funcione en el navegador. Esto es normal y seguro.
                            </p>
                        </div>

                        <ol class="list-decimal list-inside space-y-2 text-sm text-gray-600">
                            <li>Descarga la herramienta traductora de drivers <strong>Zadig</strong>.</li>
                            <li>Conecta tu impresora USB y enciéndela.</li>
                            <li>Abre Zadig. Si no ves tu impresora, ve al menú <strong>Options</strong> y marca
                                <strong>List All Devices</strong>.
                            </li>
                            <li>Selecciona tu impresora en la lista desplegable.</li>
                            <li>Asegúrate de que la casilla de la derecha diga <strong>WinUSB</strong> (verás una flecha
                                verde apuntando hacia ella).</li>
                            <li>Haz clic en el botón <strong>Replace Driver</strong> o <strong>Install Driver</strong>.
                            </li>
                            <li>Espera a que termine y reinicia esta página completa.</li>
                        </ol>

                        <div class="flex justify-center py-4">
                            <a href="https://zadig.akeo.ie/" target="_blank"
                                class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                                Descargar Zadig (Sitio Oficial)
                            </a>
                        </div>
                    </div>
                    <div class="items-center px-4 py-3">
                        <button id="close-driver-help"
                            onclick="document.getElementById('driver-help-modal').classList.add('hidden')"
                            class="px-4 py-2 bg-gray-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-300">
                            Entendido, cerrar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <img src="https://i.imgur.com/4SmaZVt.png" crossorigin="anonymous" alt="Logo"
                class="mx-auto h-36 w-auto mb-6">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">Registro de Comida</h1>
            <p class="text-center text-gray-500 mb-6">Busque por nombre o número de empleado</p>

            <div class="mb-4 relative text-left">
                <label for="employeeSearch" class="block text-gray-700 text-sm font-bold mb-2">Buscar Empleado:</label>
                <div id="search-results-container"
                    class="absolute bottom-full left-0 right-0 bg-white border mb-1 rounded-lg shadow-lg z-10 max-h-60 overflow-y-auto hidden">
                </div>
                <input type="text" id="employeeSearch"
                    class="shadow-inner appearance-none border-2 border-gray-200 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Ej: Juan Perez o 12345" autocomplete="off">
            </div>

            <button id="submitButton"
                class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transform hover:scale-105 transition-transform duration-200">Aceptar</button>
        </div>
    </div>

    <!-- PÁGINA ADMIN -->
    <div id="admin-dashboard-page"
        class="page-container hidden container mx-auto p-4 space-y-8 mt-24 md:mt-16 lg:mt-12">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Panel de Administración</h1>
            <button id="logout-button"
                class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Cerrar Sesión</button>
        </div>

        <div class="bg-white p-4 rounded-2xl shadow-lg flex items-center justify-between">
            <label for="admin-comedor-selector" class="font-bold text-gray-600 mr-2">Comedor Activo:</label>
            <select id="admin-comedor-selector" class="p-2 border-2 border-gray-200 rounded-lg flex-grow"></select>
        </div>

        <!-- Tabs -->
        <div class="flex flex-wrap border-b border-gray-200">
            <button data-admin-page="gestion"
                class="admin-nav-button py-2 px-4 font-semibold text-blue-600 border-b-2 border-blue-600">Gestión de
                Empleados</button>
            <button data-admin-page="consumos"
                class="admin-nav-button py-2 px-4 font-semibold text-gray-500 hover:text-blue-600">Consumos</button>
            <button data-admin-page="tipos"
                class="admin-nav-button py-2 px-4 font-semibold text-gray-500 hover:text-blue-600">Tipos</button>
            <button data-admin-page="comedores"
                class="admin-nav-button py-2 px-4 font-semibold text-gray-500 hover:text-blue-600">Comedores</button>
            <button data-admin-page="historia"
                class="admin-nav-button py-2 px-4 font-semibold text-gray-500 hover:text-blue-600">Historia</button>
            <button data-admin-page="usuarios"
                class="admin-nav-button py-2 px-4 font-semibold text-gray-500 hover:text-blue-600">Usuarios</button>
        </div>

        <!-- Contenido Admin -->
        <div id="admin-content-container">
            <!-- Gestión de Empleados -->
            <div id="admin-gestion-page">
                <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                    <h2 class="text-xl font-bold text-gray-700 mb-4">Gestionar Empleados</h2>

                    <div class="grid md:grid-cols-4 gap-4 mb-6">
                        <input type="number" id="new-employee-id" placeholder="Número (Opcional)"
                            class="p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="new-employee-name" placeholder="Nombre Completo"
                            class="p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="new-employee-tipo"
                            class="p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Seleccione tipo...</option>
                        </select>
                        <button id="add-employee-button"
                            class="md:col-span-1 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Agregar
                            Empleado</button>
                    </div>

                    <div class="mb-4 flex gap-4">
                        <input type="text" id="admin-employee-search" placeholder="Buscar empleado..."
                            class="flex-grow p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">

                        <!-- Importar Empleados -->
                        <div class="flex items-center">
                            <input type="file" id="import-employees-file" accept=".csv, .xlsx, .xls" class="hidden">
                            <button onclick="document.getElementById('import-employees-file').click()"
                                class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Importar CSV/Excel
                            </button>

                            <!-- Descargar Todos los Gafetes -->
                            <button id="download-all-badges-button"
                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg flex items-center gap-2 ml-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Gafetes (ZIP)
                            </button>
                        </div>
                    </div>

                    <div id="admin-table-container" class="overflow-x-auto"></div>
                </div>
            </div>

            <!-- Gestión de Usuarios -->
            <div id="admin-usuarios-page" class="hidden">
                <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-700">Gestión de Usuarios del Sistema</h2>
                        <button id="btn-add-user"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 4v16m8-8H4" />
                            </svg>
                            Agregar Usuario
                        </button>
                    </div>

                    <div class="mb-4">
                        <input type="text" id="admin-users-search" placeholder="Buscar usuario..."
                            class="w-full p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full leading-normal">
                            <thead>
                                <tr>
                                    <th
                                        class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                        Email</th>
                                    <th
                                        class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                        Nombre Completo</th>
                                    <th
                                        class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                        Rol</th>
                                    <th
                                        class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                        Comedor</th>
                                    <th
                                        class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                        Estado</th>
                                    <th
                                        class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                        Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="admin-users-table-body">
                                <!-- Filas generadas dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Consumos -->
            <div id="admin-consumos-page" class="hidden">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-700">Consumos de la Semana Actual</h2>
                        <button id="export-consumos-button"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Exportar Excel
                        </button>
                    </div>
                    <div id="current-log-table-container"></div>
                </div>
            </div>

            <!-- Tipos -->
            <div id="admin-tipos-page" class="hidden">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-700 mb-4">Gestionar Tipos de Empleados</h2>

                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <input type="text" id="new-tipo-descripcion" placeholder="Descripción del tipo"
                            class="md:col-span-2 p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="add-tipo-button"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">
                            Agregar Tipo
                        </button>
                    </div>

                    <div id="tipos-table-container" class="overflow-x-auto"></div>
                </div>
            </div>

            <!-- Comedores -->
            <div id="admin-comedores-page" class="hidden">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-700 mb-4">Gestionar Comedores</h2>

                    <div class="grid md:grid-cols-4 gap-4 mb-6">
                        <input type="text" id="new-comedor-id" placeholder="ID del comedor"
                            class="p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="new-comedor-nombre" placeholder="Nombre del comedor"
                            class="p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="new-comedor-empresa" placeholder="ID de empresa"
                            class="p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="add-comedor-button"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">
                            Agregar Comedor
                        </button>
                    </div>

                    <div id="comedores-table-container" class="overflow-x-auto"></div>
                </div>
            </div>

            <!-- Historia -->
            <div id="admin-historia-page" class="hidden">
                <!-- Vista de Lista -->
                <div id="historia-list-view" class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-700 mb-4">Historial de Consumos Semanales</h2>
                    <div id="historia-table-container" class="overflow-x-auto">
                        <p class="text-gray-500 text-center py-4">Cargando historial...</p>
                    </div>
                </div>

                <!-- Vista de Detalles -->
                <div id="historia-detail-view" class="hidden bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex items-center gap-4 mb-6">
                        <button id="back-to-historia-list"
                            class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                            </svg>
                            Volver
                        </button>
                        <div>
                            <h2 class="text-xl font-bold text-gray-700">Detalles de la Semana</h2>
                            <p class="text-sm text-gray-500" id="historia-detail-subtitle">Semana del ...</p>
                        </div>
                        <div class="ml-auto">
                            <button id="export-historia-button"
                                class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                                Exportar Excel
                            </button>
                        </div>
                    </div>

                    <div id="historia-detail-table-container" class="overflow-x-auto">
                        <!-- Aquí va la tabla de detalles -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PÁGINA VERIFICADOR -->
    <div id="verificador-dashboard-page" class="page-container hidden container mx-auto p-4 space-y-8 mt-12">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Panel de Verificación en Tiempo Real</h1>
            <div class="flex gap-4">
                <div class="flex items-center gap-2 bg-green-100 px-4 py-2 rounded-lg text-green-800 font-bold">
                    <div id="socket-status-indicator" class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></div>
                    <span id="socket-status-text">Conectado</span>
                </div>
                <button id="logout-button-verificador"
                    class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Cerrar Sesión</button>
            </div>
        </div>

        <!-- Tabs de Navegación Verificador -->
        <div class="flex mb-6 border-b-2 border-gray-200">
            <button id="tab-verificador-realtime"
                class="py-2 px-4 border-b-2 border-blue-500 text-blue-600 font-bold focus:outline-none transition-colors">
                Tiempo Real
            </button>
            <button id="tab-verificador-history"
                class="py-2 px-4 border-b-2 border-transparent text-gray-500 font-medium hover:text-blue-500 focus:outline-none transition-colors">
                Historial Hoy
            </button>
        </div>

        <!-- VISTA TIEMPO REAL -->
        <div id="verificador-realtime-view">

            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-700 mb-4">Últimos Consumos Registrados</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full leading-normal">
                        <thead>
                            <tr>
                                <th
                                    class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    Hora
                                </th>
                                <th
                                    class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    Empleado
                                </th>
                                <th
                                    class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    Número
                                </th>
                                <th
                                    class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    Tipo
                                </th>
                                <th
                                    class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    Comedor
                                </th>
                                <th
                                    class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    Acciones
                                </th>
                            </tr>
                        </thead>
                        <tbody id="real-time-log-body">
                            <!-- Las filas se agregarán dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- VISTA HISTORIAL HOY -->
    <div id="verificador-history-view" class="hidden">
        <div class="bg-white p-6 rounded-2xl shadow-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-700">Historial de Consumos del Día</h2>
                <button id="refresh-history-btn" class="text-blue-600 hover:text-blue-800">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
            </div>

            <div class="mb-4">
                <input type="text" id="verificador-history-search" placeholder="Buscar por nombre o número..."
                    class="w-full p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full leading-normal">
                    <thead>
                        <tr>
                            <th
                                class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Hora</th>
                            <th
                                class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Empleado</th>
                            <th
                                class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Número</th>
                            <th
                                class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Tipo</th>
                            <th
                                class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                Comedor</th>
                        </tr>
                    </thead>
                    <tbody id="verificador-history-body">
                        <!-- Filas generadas dinámicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    </div>

    <!-- Modales -->
    <!-- Modal de Validación de Consumo -->
    <div id="validate-consumption-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Validar Consumo</h2>
            <p class="text-gray-600 text-center mb-6">
                ¿Está seguro de validar el consumo para el empleado <br>
                <span id="validate-emp-name" class="font-bold text-gray-800"></span>
                (<span id="validate-emp-number" class="font-bold text-gray-800"></span>)?
                <br><br>
                <span class="text-sm text-gray-500">Esta acción eliminará el registro de la vista actual.</span>
            </p>

            <input type="hidden" id="validate-row-id">

            <div class="flex gap-3">
                <button id="cancel-validate-button"
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">
                    Cancelar
                </button>
                <button id="confirm-validate-button"
                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">
                    Validar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Contraseña para Logout -->
    <div id="logout-password-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Confirmar Cierre de Sesión</h2>
            <p class="text-gray-600 text-center mb-6">Por seguridad, ingrese su contraseña para confirmar.</p>
            <input type="password" id="logout-confirm-password"
                class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Contraseña actual">
            <p id="logout-error-msg" class="text-red-500 text-sm text-center mb-4 hidden"></p>
            <div class="flex gap-3">
                <button id="cancel-logout-btn"
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">Cancelar</button>
                <button id="confirm-logout-btn"
                    class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg">Cerrar
                    Sesión</button>
            </div>
        </div>
    </div>

    <div id="confirmation-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50"></div>
    <div id="admin-password-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50"></div>
    <div id="comedor-selector-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50"></div>

    <!-- Contenedor oculto para generación masiva de gafetes -->
    <div id="batch-badge-container" class="fixed top-0 left-0 -z-50 opacity-0 pointer-events-none">
        <div id="batch-badge-content" class="bg-white border-4 border-gray-300 rounded-xl p-6 text-center w-[400px]">
            <img src="https://i.imgur.com/4SmaZVt.png" crossorigin="anonymous" alt="Logo"
                class="mx-auto h-24 w-auto mb-4">
            <div id="batch-badge-qr-container" class="flex justify-center mb-4"></div>
            <h3 id="batch-badge-employee-name" class="text-xl font-bold text-gray-800 mb-2"></h3>
            <p id="batch-badge-employee-number" class="text-gray-600"></p>
        </div>
    </div>

    <!-- Modal de Gafete -->
    <div id="badge-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Gafete de Empleado</h2>

            <!-- Contenedor del gafete para imprimir -->
            <div id="badge-content" class="bg-white border-4 border-gray-300 rounded-xl p-6 mb-6 text-center">
                <!-- Logo -->
                <img src="https://i.imgur.com/4SmaZVt.png" crossorigin="anonymous" alt="Logo"
                    class="mx-auto h-24 w-auto mb-4">

                <!-- QR Code -->
                <div id="badge-qr-container" class="flex justify-center mb-4">
                    <canvas id="badge-qr-canvas"></canvas>
                </div>

                <!-- Nombre del empleado -->
                <h3 id="badge-employee-name" class="text-xl font-bold text-gray-800 mb-2"></h3>
                <p id="badge-employee-number" class="text-gray-600"></p>
            </div>

            <!-- Botones de acción -->
            <div class="flex flex-col gap-3">
                <button id="print-badge-button"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </svg>
                    Imprimir Gafete
                </button>

                <button id="download-badge-button"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Descargar Imagen
                </button>

                <button id="close-badge-button"
                    class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Editar Empleado -->
    <div id="edit-employee-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Editar Empleado</h2>

            <!-- Formulario de edición -->
            <div class="space-y-4 mb-6">
                <div>
                    <label for="edit-employee-name" class="block text-gray-700 text-sm font-bold mb-2">
                        Nombre del Empleado:
                    </label>
                    <input type="text" id="edit-employee-name"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Nombre completo">
                </div>

                <div>
                    <label for="edit-employee-number" class="block text-gray-700 text-sm font-bold mb-2">
                        Número de Empleado:
                    </label>
                    <input type="text" id="edit-employee-number"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Número (opcional)">
                </div>

                <div>
                    <label for="edit-employee-tipo" class="block text-gray-700 text-sm font-bold mb-2">
                        Tipo de Empleado:
                    </label>
                    <select id="edit-employee-tipo"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Seleccione tipo...</option>
                    </select>
                </div>

                <input type="hidden" id="edit-employee-id">
            </div>

            <!-- Botones de acción -->
            <div class="flex gap-3">
                <button id="cancel-edit-employee-button"
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">
                    Cancelar
                </button>

                <button id="save-edit-employee-button"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                    Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Editar Comedor -->
    <div id="edit-comedor-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Editar Comedor</h2>

            <div class="space-y-4 mb-6">
                <div>
                    <label for="edit-comedor-name" class="block text-gray-700 text-sm font-bold mb-2">
                        Nombre del Comedor:
                    </label>
                    <input type="text" id="edit-comedor-name"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Nombre del comedor">
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="edit-comedor-require-pin"
                        class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500">
                    <label for="edit-comedor-require-pin" class="ml-2 block text-gray-700 font-bold">
                        Requiere PIN para consumos
                    </label>
                </div>

                <input type="hidden" id="edit-comedor-id">
            </div>

            <div class="flex gap-3">
                <button id="cancel-edit-comedor-button"
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">
                    Cancelar
                </button>

                <button id="save-edit-comedor-button"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                    Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Gestión de Usuario (Crear/Editar) -->
    <div id="manage-user-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center" id="manage-user-modal-title">Agregar
                Usuario
            </h2>

            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Email:</label>
                    <input type="email" id="manage-user-email"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Nombre Completo:</label>
                    <input type="text" id="manage-user-fullname"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div id="manage-user-password-container">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Contraseña:</label>
                    <input type="password" id="manage-user-password"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Rol:</label>
                    <select id="manage-user-role"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">

                    </select>
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Comedor Asignado:</label>
                    <select id="manage-user-comedor"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Ninguno (Global)</option>
                    </select>
                </div>
                <input type="hidden" id="manage-user-id">
            </div>

            <div class="flex gap-3">
                <button id="btn-cancel-user"
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">Cancelar</button>
                <button id="btn-save-user"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Cambio de Contraseña de Usuario -->
    <div id="change-user-password-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Cambiar Contraseña</h2>
            <p class="text-gray-600 text-center mb-4">Ingrese la nueva contraseña para el usuario <span
                    id="change-pass-user-email" class="font-bold"></span></p>

            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2">Nueva Contraseña:</label>
                    <input type="password" id="new-user-password"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <input type="hidden" id="change-pass-user-id">

            <div class="flex gap-3">
                <button id="btn-cancel-pass"
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">Cancelar</button>
                <button id="btn-save-pass"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Actualizar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Registro de PIN -->
    <div id="register-pin-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Registrar PIN</h2>
            <p class="text-gray-600 text-center mb-6">Debes registrar un PIN de 4 dígitos para continuar</p>

            <div class="space-y-4 mb-6">
                <div>
                    <label for="new-pin-input" class="block text-gray-700 text-sm font-bold mb-2">
                        Ingresa tu PIN (4 dígitos):
                    </label>
                    <input type="password" id="new-pin-input" maxlength="4"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg text-center text-2xl tracking-widest focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="••••">
                </div>

                <div>
                    <label for="confirm-pin-input" class="block text-gray-700 text-sm font-bold mb-2">
                        Confirma tu PIN:
                    </label>
                    <input type="password" id="confirm-pin-input" maxlength="4"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg text-center text-2xl tracking-widest focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="••••">
                </div>
            </div>

            <button id="save-pin-button"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                Registrar PIN
            </button>
        </div>
    </div>

    <!-- Modal de Confirmación de Identidad -->
    <div id="confirm-identity-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Confirmar Identidad</h2>
            <p class="text-xl text-gray-700 text-center mb-2">¿Eres tú?</p>

            <div class="bg-blue-50 rounded-lg p-4 mb-6">
                <p class="text-lg font-bold text-gray-800 text-center" id="confirm-employee-name"></p>
                <p class="text-gray-600 text-center" id="confirm-employee-number"></p>
            </div>

            <div class="flex gap-3">
                <button id="cancel-identity-button"
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">
                    Cancelar
                </button>

                <button id="accept-identity-button"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                    Aceptar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Verificación de PIN -->
    <div id="verify-pin-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Verificar PIN</h2>
            <p class="text-gray-600 text-center mb-6">Ingresa tu PIN de 4 dígitos</p>

            <div class="mb-6">
                <input type="password" id="verify-pin-input" maxlength="4"
                    class="w-full p-3 border-2 border-gray-300 rounded-lg text-center text-2xl tracking-widest focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="••••">
            </div>

            <div class="flex gap-3">
                <button id="cancel-verify-pin-button"
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">
                    Cancelar
                </button>

                <button id="verify-pin-button"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                    Verificar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Cambio de PIN (Admin) -->
    <div id="change-pin-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Restaurar NIP</h2>
            <p class="text-gray-600 text-center mb-6">¿Estás seguro de que deseas eliminar el NIP de este empleado?
            </p>
            <p class="text-xl font-bold text-gray-800 text-center mb-6" id="change-pin-employee-name"></p>

            <input type="hidden" id="change-pin-employee-id">

            <div class="flex gap-3">
                <button id="cancel-change-pin-button"
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">
                    Cancelar
                </button>

                <button id="save-change-pin-button"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                    Aceptar
                </button>
            </div>
        </div>
    </div>

    <div id="fullscreen-message-container"
        class="hidden fixed inset-0 z-50 flex items-center justify-center text-white text-center transition-opacity duration-300">
    </div>

    <!-- Modal de Confirmación de Logout -->
    <div id="logout-password-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Confirmar Salida</h2>
            <p class="text-gray-600 text-center mb-6">Ingresa tu contraseña para cerrar sesión</p>

            <div class="mb-4">
                <input type="password" id="logout-confirm-password"
                    class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Contraseña">
                <p id="logout-error-msg" class="text-red-500 text-sm mt-2 hidden text-center"></p>
            </div>

            <div class="flex gap-3">
                <button id="cancel-logout-btn"
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">
                    Cancelar
                </button>
                <button id="confirm-logout-btn"
                    class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg">
                    Cerrar Sesión
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript Refactorizado -->
    <script type="module">
        import * as OfflineDB from './db-offline.js';

        // ============================================================================
        // CONFIGURACIÓN
        // ============================================================================

        // Determinar URL de la API basándose en el entorno
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:';
        const API_URL = isLocal ? 'http://localhost:3000/api' : '/api';

        const ADMIN_PASSWORD = '1560';
        var consecutivo = 0;
        var reinicio = false;

        let appState = {
            comedores: [],
            activeComedorId: null,
            empleados: [],
            consumos: [],
            tipos: [],
            currentUser: null  // Usuario autenticado
        };

        let audioStarted = false;

        let currentAdminPage = 'gestion';
        let socket = null;

        // ============================================================================
        // API
        // ============================================================================
        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_URL}${endpoint}`, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                showFullscreenMessage(false, 'Error de Conexión', error.message);
                throw error;
            }
        }

        // ============================================================================
        // AUTENTICACIÓN
        // ============================================================================
        async function login(email, password) {
            try {
                const response = await apiRequest('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                if (response.success) {
                    appState.currentUser = response.user;

                    // Guardar en localStorage
                    localStorage.setItem('currentUser', JSON.stringify(response.user));

                    // Actualizar nombre de usuario en el badge
                    updateUserDisplay();

                    // Redirigir según el rol
                    if (response.user.role === 'administrador') {
                        switchPage('admin-dashboard-page');
                        await loadAllData();
                    } else if (response.user.role === 'verificador') {
                        switchPage('verificador-dashboard-page');
                        initVerificadorDashboard();
                    } else {
                        switchPage('main-page');
                        await loadAllData();
                    }

                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error en login:', error);
                throw error;
            }
        }

        function updateUserDisplay() {
            const userNameDisplay = document.getElementById('user-name-display');
            const comedorNameDisplay = document.getElementById('comedor-name-display');

            if (userNameDisplay && appState.currentUser) {
                userNameDisplay.textContent = appState.currentUser.fullName || appState.currentUser.email;
            }

            if (comedorNameDisplay && appState.currentUser && appState.currentUser.comedorId) {
                // Buscar el nombre del comedor
                const comedor = appState.comedores.find(c => c.comedor_id === appState.currentUser.comedorId);
                comedorNameDisplay.textContent = comedor ? comedor.comedor_nombre : appState.currentUser.comedorId;
            }
        }

        function logout() {
            appState.currentUser = null;
            localStorage.removeItem('currentUser');
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            switchPage('login-page');
        }

        function checkAuth() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                appState.currentUser = JSON.parse(savedUser);
                return true;
            }
            return false;
        }

        // ============================================================================
        // CARGA DE DATOS
        // ============================================================================
        async function loadAllData() {
            try {
                // Intentar sincronizar datos offline si hay conexión
                syncOfflineData();

                // Cargar comedores
                appState.comedores = await apiRequest('/comedores');




                // Determinar el comedor activo según el rol del usuario
                if (appState.currentUser) {
                    if (appState.currentUser.role === 'administrador') {
                        // Admin: usar el comedor seleccionado o el primero
                        if (!appState.activeComedorId && appState.comedores.length > 0) {
                            appState.activeComedorId = appState.comedores[0].comedor_id;
                        }
                    } else {
                        // Usuario no admin: usar SOLO su comedor asignado
                        if (appState.currentUser.comedorId) {
                            appState.activeComedorId = appState.currentUser.comedorId;
                        }
                    }
                } else {
                    // Sin usuario (fallback)
                    if (!appState.activeComedorId && appState.comedores.length > 0) {
                        appState.activeComedorId = appState.comedores[0].comedor_id;
                    }
                }

                // Cargar empleados del comedor activo
                if (appState.activeComedorId) {
                    appState.empleados = await apiRequest(`/empleados?comedor_id=${appState.activeComedorId}`);
                    // 💾 Guardar empleados en IndexedDB para uso offline
                    await OfflineDB.saveEmployees(appState.empleados);
                    console.log('✅ Empleados guardados offline');
                }

                // Cargar tipos
                await loadTipos();

                renderAll();

                // Actualizar display del usuario (para mostrar nombre del comedor)
                updateUserDisplay();
            } catch (error) {
                console.error('Error cargando datos (posiblemente offline):', error);

                // 📂 Intentar cargar desde IndexedDB si falla la API
                try {
                    const offlineEmployees = await OfflineDB.getEmployees();
                    if (offlineEmployees && offlineEmployees.length > 0) {
                        appState.empleados = offlineEmployees;
                        console.log('⚠️ Cargados empleados desde Offline DB');
                        //showFullscreenMessage(true, 'Modo Offline', 'Usando datos locales');
                        renderAll();
                    }
                } catch (dbError) {
                    console.error('Error cargando IndexedDB:', dbError);
                }
            }
        }

        // ============================================================================
        // RENDERIZADO
        // ============================================================================
        function renderAll() {
            renderComedorSelector();
            renderAdminTable();
            renderComedoresTable();
            updateActiveComedorName();
        }

        function renderComedorSelector() {
            const selector = document.getElementById('admin-comedor-selector');
            if (!selector) return;

            selector.innerHTML = appState.comedores.map(c =>
                `<option value="${c.comedor_id}" ${c.comedor_id === appState.activeComedorId ? 'selected' : ''}>
                    ${c.comedor_nombre}
                </option>`
            ).join('');
        }

        function renderAdminTable(searchTerm = '') {
            const container = document.getElementById('admin-table-container');
            if (!container) return;

            const filtered = appState.empleados.filter(e =>
                !searchTerm ||
                e.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (e.number && e.number.includes(searchTerm))
            );

            container.innerHTML = `
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left">Nombre</th>
                            <th class="px-4 py-2 text-left">Número</th>
                            <th class="px-4 py-2 text-left">Tipo</th>
                            <th class="px-4 py-2 text-left">PIN</th>
                            <th class="px-4 py-2 text-left">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(emp => {
                // Buscar el tipo si tiene tipo_id
                let tipoDesc = '-';
                if (emp.tipo_id) {
                    const tipo = appState.tipos.find(t => t.id_tipo === emp.tipo_id);
                    tipoDesc = tipo ? tipo.descripcion : `ID: ${emp.tipo_id}`;
                } else if (emp.type) {
                    tipoDesc = emp.type;
                }

                return `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="px-4 py-2">${emp.name}</td>
                                <td class="px-4 py-2">${emp.number || '-'}</td>
                                <td class="px-4 py-2">${tipoDesc}</td>
                                <td class="px-4 py-2">${emp.pin ? '✓' : '✗'}</td>
                                <td class="px-4 py-2">
                                    <select onchange="handleEmployeeAction(this.value, '${emp.internal_id}', '${emp.name.replace(/'/g, "\\'")}', '${emp.number || ''}')" 
                                        class="p-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Seleccionar...</option>
                                        <option value="edit">Editar</option>
                                        <option value="change_pin">Eliminar NIP</option>
                                        <option value="badge">Generar Gafete</option>
                                        <option value="delete">Eliminar</option>
                                    </select>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;
        }

        function updateActiveComedorName() {
            const nameSpan = document.getElementById('active-comedor-name');
            if (!nameSpan) return;

            const activeComedor = appState.comedores.find(c => c.comedor_id === appState.activeComedorId);
            nameSpan.textContent = activeComedor ? activeComedor.comedor_nombre : 'Sin comedor';
        }

        async function renderConsumosTable() {
            const container = document.getElementById('current-log-table-container');
            if (!container) return;

            try {
                console.log('🔍 Cargando consumos para comedor:', appState.activeComedorId);

                // Cargar consumos de la semana actual
                const consumos = await apiRequest(`/consumos/semana-actual/${appState.activeComedorId}`);

                console.log('📊 Consumos recibidos:', consumos);
                console.log('📊 Cantidad:', consumos ? consumos.length : 0);

                if (!consumos || consumos.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <p class="text-lg">No hay consumos registrados esta semana</p>
                            <p class="text-sm mt-2">Comedor ID: ${appState.activeComedorId}</p>
                        </div>
                    `;
                    return;
                }

                // Agrupar por día
                const diasSemana = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado', 'Domingo'];
                const consumosPorDia = {};

                consumos.forEach(c => {
                    if (!consumosPorDia[c.day_name]) {
                        consumosPorDia[c.day_name] = [];
                    }
                    consumosPorDia[c.day_name].push(c);
                });
                console.log('container1:', container);
                container.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 text-left">Empleado</th>
                                    ${diasSemana.map(dia => `<th class="px-4 py-2 text-center">${dia.substring(0, 3)}</th>`).join('')}
                                    <th class="px-4 py-2 text-center">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${generateConsumosRows(consumos, diasSemana)}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                        <h3 class="font-bold text-lg mb-2">Resumen Semanal</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            ${diasSemana.map(dia => {
                    const consumosDia = consumosPorDia[dia] || [];
                    const total = consumosDia.reduce((sum, c) => sum + parseInt(c.consumption_count || 0), 0);
                    return `
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-blue-600">${total}</div>
                                        <div class="text-sm text-gray-600">${dia}</div>
                                    </div>
                                `;
                }).join('')}
                        </div>
                    </div>
                `;
                console.log('container1:', container);
            } catch (error) {
                console.error('Error cargando consumos:', error);
                container.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <p class="text-lg">Error al cargar consumos</p>
                        <p class="text-sm">${error.message}</p>
                    </div>
                `;
            }
        }

        function generateConsumosRows(consumos, diasSemana) {
            // Agrupar por empleado
            const empleadosMap = {};

            consumos.forEach(c => {
                if (!empleadosMap[c.employee_id]) {
                    empleadosMap[c.employee_id] = {
                        nombre: c.employee_name || 'Desconocido',
                        consumos: {}
                    };
                }
                empleadosMap[c.employee_id].consumos[c.day_name] = parseInt(c.consumption_count || 0);
            });

            // Generar filas
            return Object.entries(empleadosMap).map(([employeeId, data]) => {
                const consumosPorDia = diasSemana.map(dia => data.consumos[dia] || 0);
                const total = consumosPorDia.reduce((sum, count) => sum + count, 0);

                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-2">${data.nombre}</td>
                        ${consumosPorDia.map(count => `
                            <td class="px-4 py-2 text-center ${count > 0 ? 'bg-green-100 font-bold' : 'text-gray-400'}">
                                ${count > 0 ? count : '-'}
                            </td>
                        `).join('')}
                        <td class="px-4 py-2 text-center font-bold text-blue-600">${total}</td>
                    </tr>
                `;
            }).join('');
        }

        // ============================================================================
        // FUNCIONES PARA TIPOS
        // ============================================================================

        async function loadTipos() {
            try {
                appState.tipos = await apiRequest('/tipos');
                renderTiposSelect();
                renderTiposTable();
            } catch (error) {
                console.error('Error cargando tipos:', error);
            }
        }

        function renderTiposSelect() {
            const select = document.getElementById('new-employee-tipo');
            if (!select) return;

            select.innerHTML = '<option value="">Seleccione tipo...</option>';
            appState.tipos.forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo.id_tipo;
                option.textContent = tipo.descripcion;
                select.appendChild(option);
            });
        }

        function renderTiposTable() {
            const container = document.getElementById('tipos-table-container');
            if (!container) return;

            if (appState.tipos.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p class="text-lg">No hay tipos registrados</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left">ID</th>
                            <th class="px-4 py-2 text-left">Descripción</th>
                            <th class="px-4 py-2 text-left">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appState.tipos.map(tipo => `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="px-4 py-2">${tipo.id_tipo}</td>
                                <td class="px-4 py-2">
                                    <span id="tipo-desc-${tipo.id_tipo}">${tipo.descripcion}</span>
                                    <input type="text" id="tipo-edit-${tipo.id_tipo}" value="${tipo.descripcion}" 
                                        class="hidden p-2 border rounded">
                                </td>
                                <td class="px-4 py-2 space-x-2">
                                    <button onclick="editTipo(${tipo.id_tipo})" id="btn-edit-${tipo.id_tipo}"
                                        class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
                                        Editar
                                    </button>
                                    <button onclick="saveTipo(${tipo.id_tipo})" id="btn-save-${tipo.id_tipo}"
                                        class="hidden bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">
                                        Guardar
                                    </button>
                                    <button onclick="cancelEditTipo(${tipo.id_tipo})" id="btn-cancel-${tipo.id_tipo}"
                                        class="hidden bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600">
                                        Cancelar
                                    </button>
                                    <button onclick="deleteTipo(${tipo.id_tipo})"
                                        class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                                        Eliminar
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        window.editTipo = function (id) {
            document.getElementById(`tipo-desc-${id}`).classList.add('hidden');
            document.getElementById(`tipo-edit-${id}`).classList.remove('hidden');
            document.getElementById(`btn-edit-${id}`).classList.add('hidden');
            document.getElementById(`btn-save-${id}`).classList.remove('hidden');
            document.getElementById(`btn-cancel-${id}`).classList.remove('hidden');
        };

        window.cancelEditTipo = function (id) {
            document.getElementById(`tipo-desc-${id}`).classList.remove('hidden');
            document.getElementById(`tipo-edit-${id}`).classList.add('hidden');
            document.getElementById(`btn-edit-${id}`).classList.remove('hidden');
            document.getElementById(`btn-save-${id}`).classList.add('hidden');
            document.getElementById(`btn-cancel-${id}`).classList.add('hidden');
        };

        window.saveTipo = async function (id) {
            const newDesc = document.getElementById(`tipo-edit-${id}`).value.trim();

            if (!newDesc) {
                alert('La descripción no puede estar vacía');
                return;
            }

            try {
                await apiRequest(`/tipos/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ descripcion: newDesc })
                });

                await loadTipos();
                showFullscreenMessage(true, 'Éxito', 'Tipo actualizado');
            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        };

        window.deleteTipo = async function (id) {
            if (!confirm('¿Estás seguro de eliminar este tipo?')) return;

            try {
                await apiRequest(`/tipos/${id}`, { method: 'DELETE' });
                await loadTipos();
                showFullscreenMessage(true, 'Éxito', 'Tipo eliminado');
            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        };

        // ============================================================================
        // FUNCIONES PARA COMEDORES
        // ============================================================================

        function renderComedoresTable() {
            const container = document.getElementById('comedores-table-container');
            if (!container) return;

            if (appState.comedores.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p class="text-lg">No hay comedores registrados</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left">ID</th>
                            <th class="px-4 py-2 text-left">Nombre</th>
                            <th class="px-4 py-2 text-left">Empresa</th>
                            <th class="px-4 py-2 text-left">Require PIN</th>
                            <th class="px-4 py-2 text-left">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appState.comedores.map(comedor => `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="px-4 py-2">${comedor.comedor_id}</td>
                                <td class="px-4 py-2">${comedor.comedor_nombre}</td>
                                <td class="px-4 py-2">${comedor.empresa_nombre || comedor.empresa_id}</td>
                                <td class="px-4 py-2 text-center">
                                    <span class="${comedor.require_pin ? 'text-green-600 font-bold' : 'text-gray-400'}">
                                        ${comedor.require_pin ? 'SÍ' : 'NO'}
                                    </span>
                                </td>
                                <td class="px-4 py-2 space-x-2">
                                    <button onclick="editComedor('${comedor.comedor_id}')"
                                        class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
                                        Editar
                                    </button>
                                    <button onclick="deleteComedor('${comedor.comedor_id}')"
                                        class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                                        Eliminar
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        window.editComedor = function (id) {
            const comedor = appState.comedores.find(c => c.comedor_id === id);
            if (!comedor) return;

            // Abrir modal
            const modal = document.getElementById('edit-comedor-modal');
            modal.classList.remove('hidden');

            // Cargar datos
            document.getElementById('edit-comedor-id').value = id;
            document.getElementById('edit-comedor-name').value = comedor.comedor_nombre;
            document.getElementById('edit-comedor-require-pin').checked = comedor.require_pin;
        };

        // Event Listeners para Editar Comedor
        document.getElementById('cancel-edit-comedor-button')?.addEventListener('click', () => {
            document.getElementById('edit-comedor-modal').classList.add('hidden');
        });

        document.getElementById('save-edit-comedor-button')?.addEventListener('click', async () => {
            const id = document.getElementById('edit-comedor-id').value;
            const newNombre = document.getElementById('edit-comedor-name').value.trim();
            const requirePin = document.getElementById('edit-comedor-require-pin').checked;

            if (!newNombre) {
                alert('El nombre no puede estar vacío');
                return;
            }

            try {
                await apiRequest(`/ comedores / ${id} `, {
                    method: 'PUT',
                    body: JSON.stringify({
                        name: newNombre,
                        require_pin: requirePin
                    })
                });

                document.getElementById('edit-comedor-modal').classList.add('hidden');
                await loadAllData();
                showFullscreenMessage(true, 'Éxito', 'Comedor actualizado');
            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        });

        window.deleteComedor = async function (id) {
            if (!confirm('¿Estás seguro de eliminar este comedor? Esto puede afectar a empleados y usuarios asignados.')) return;

            try {
                await apiRequest(`/ comedores / ${id} `, { method: 'DELETE' });
                await loadAllData();
                showFullscreenMessage(true, 'Éxito', 'Comedor eliminado');
            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        };

        // ============================================================================
        // ACCIONES
        // ============================================================================
        // Variable global para almacenar el empleado actual en proceso
        let currentEmployeeForPIN = null;

        async function registerConsumption(employeeId) {
            try {
                // Buscar el empleado completo
                const employee = appState.empleados.find(e => e.internal_id === employeeId);

                if (!employee) {
                    showFullscreenMessage(false, 'Error', 'Empleado no encontrado');
                    return;
                }

                currentEmployeeForPIN = employee;
                console.log('appState', appState);
                // Verificar si el comedor requiere PIN
                // El activeComedorId es un string (UUID), debemos buscar el objeto completo
                const currentComedor = appState.comedores.find(c => c.comedor_id === appState.activeComedorId);
                console.log('Comedor actual:', currentComedor);
                // Si encontramos el comedor y su configuración dice que NO requiere PIN
                if (currentComedor && currentComedor.require_pin === false) {
                    // Registrar directamente sin pedir PIN
                    await completeConsumptionRegistration();
                    return;
                }

                // Verificar si tiene PIN (flujo normal)
                if (!employee.pin || employee.pin === null) {
                    // No tiene PIN - Mostrar modal de registro
                    showRegisterPINModal(employee);
                } else {
                    // Tiene PIN - Mostrar modal de confirmación de identidad
                    showConfirmIdentityModal(employee);
                }

            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        }

        // ============================================================================
        // FUNCIONES DE GESTIÓN DE PIN
        // ============================================================================

        function showRegisterPINModal(employee) {
            const modal = document.getElementById('register-pin-modal');
            modal.classList.remove('hidden');

            // Limpiar inputs
            document.getElementById('new-pin-input').value = '';
            document.getElementById('confirm-pin-input').value = '';

            // Focus en el primer input
            setTimeout(() => {
                document.getElementById('new-pin-input').focus();
            }, 100);
        }

        function showConfirmIdentityModal(employee) {
            const modal = document.getElementById('confirm-identity-modal');
            modal.classList.remove('hidden');

            // Mostrar datos del empleado
            document.getElementById('confirm-employee-name').textContent = employee.name;
            document.getElementById('confirm-employee-number').textContent = `#${employee.number || employee.internal_id} `;
        }

        function showVerifyPINModal() {
            // Cerrar modal de confirmación
            document.getElementById('confirm-identity-modal').classList.add('hidden');

            // Abrir modal de verificación
            const modal = document.getElementById('verify-pin-modal');
            modal.classList.remove('hidden');

            // Limpiar input
            document.getElementById('verify-pin-input').value = '';

            // Focus en el input
            setTimeout(() => {
                document.getElementById('verify-pin-input').focus();
            }, 100);
        }

        async function completePINRegistration() {
            const newPIN = document.getElementById('new-pin-input').value;
            const confirmPIN = document.getElementById('confirm-pin-input').value;

            // Validaciones
            if (!newPIN || newPIN.length !== 4) {
                alert('El PIN debe tener 4 dígitos');
                return;
            }

            if (!/^\d{4}$/.test(newPIN)) {
                alert('El PIN debe contener solo números');
                return;
            }

            if (newPIN !== confirmPIN) {
                alert('Los PINs no coinciden');
                return;
            }

            try {
                // Actualizar el PIN del empleado
                await apiRequest(`/empleados/${currentEmployeeForPIN.internal_id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ pin: newPIN })
                });

                // ✅ Actualizar estado local inmediatamente
                currentEmployeeForPIN.pin = newPIN;
                const localEmp = appState.empleados.find(e => e.internal_id === currentEmployeeForPIN.internal_id);
                if (localEmp) localEmp.pin = newPIN;

                // 💾 Actualizar cache offline
                await OfflineDB.updateEmployeePIN(currentEmployeeForPIN.internal_id, newPIN);
                console.log('✅ Local state and offline cache updated for PIN');

                // Cerrar modal
                document.getElementById('register-pin-modal').classList.add('hidden');

                // Registrar consumo directamente
                await completeConsumptionRegistration();

            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        }

        async function verifyPINAndRegister() {
            const enteredPIN = document.getElementById('verify-pin-input').value;

            if (!enteredPIN || enteredPIN.length !== 4) {
                alert('Debes ingresar un PIN de 4 dígitos');
                return;
            }

            // Verificar PIN
            if (enteredPIN === currentEmployeeForPIN.pin) {
                // PIN correcto
                document.getElementById('verify-pin-modal').classList.add('hidden');
                await completeConsumptionRegistration();
            } else {
                // PIN incorrecto
                document.getElementById('verify-pin-modal').classList.add('hidden');
                showFullscreenMessage(false, 'PIN Incorrecto', 'El PIN ingresado no es válido');

                // Limpiar después de 2 segundos
                setTimeout(() => {
                    document.getElementById('employeeSearch').value = '';
                    document.getElementById('search-results-container').classList.add('hidden');
                    currentEmployeeForPIN = null;
                }, 2000);
            }
        }

        // ============================================================================
        // IMPRESIÓN USB CON THERMAL-PRINTER-ENCODER
        // ============================================================================

        let printerDevice = null;
        let printerEndpoint = null;


        async function connectPrinter() {
            try {
                console.log('Solicitando dispositivo USB...');

                // 1. Solicitar dispositivo
                const selectedDevice = await navigator.usb.requestDevice({ filters: [] });
                printerDevice = selectedDevice;
                console.log("printerDevice", printerDevice);
                // 2. Si ya teníamos uno abierto, intentar cerrarlo elegantemente
                if (printerDevice && printerDevice.opened) {
                    try { await printerDevice.close(); } catch (e) { console.log('Error cerrando previo:', e); }
                }


                console.log('Dispositivo seleccionado:', printerDevice.productName);

                // 3. Abrir conexión
                try {
                    await printerDevice.open();
                } catch (openError) {
                    console.error("Error al abrir dispositivo:", openError);
                    if (openError.name === 'SecurityError') {
                        throw new Error('⚠️ Acceso Denegado: En Windows, es posible que necesites reemplazar el driver de la impresora por WinUSB (usando Zadig).');
                    }
                    if (openError.name === 'NetworkError') {
                        throw new Error('⚠️ Dispositivo Ocupado: Asegúrate de que no esté siendo usado por otra ventana o programa.');
                    }
                    throw new Error(`No se pudo abrir el dispositivo: ${openError.message}`);
                }
                console.log('Dispositivo abierto');

                // 4. Seleccionar configuración
                await printerDevice.selectConfiguration(1);

                // 5. Búsqueda dinámica de interfaz y endpoint de impresión
                let foundInterface = -1;
                let foundEndpoint = -1;

                for (const iface of printerDevice.configuration.interfaces) {
                    // Algunas impresoras tienen múltiples interfaces, buscamos la que tenga endpoints BULK OUT
                    const endpoint = iface.alternate.endpoints.find(ep =>
                        ep.direction === 'out' && ep.type === 'bulk'
                    );

                    if (endpoint) {
                        foundInterface = iface.interfaceNumber;
                        foundEndpoint = endpoint.endpointNumber;
                        break;
                    }
                }

                if (foundInterface === -1) {
                    throw new Error('No se encontró una interfaz de impresión compatible');
                }

                // 6. Reclamar la interfaz encontrada
                await printerDevice.claimInterface(foundInterface);
                printerEndpoint = { endpointNumber: foundEndpoint };

                console.log(`Conectado exitosamente: Interfaz ${foundInterface}, Endpoint ${foundEndpoint}`);

                // Actualizar UI
                const btnText = document.getElementById('printer-status-text');
                if (btnText) btnText.textContent = 'Impresora USB Lista';

                showFullscreenMessage(true, 'Impresora USB Conectada', `Conectado a ${printerDevice.productName}`);

                // Listener para desconexión
                navigator.usb.addEventListener('disconnect', (event) => {
                    if (event.device === printerDevice) onPrinterDisconnected();
                });

            } catch (error) {
                console.error('Error conectando impresora USB:', error);
                let msg = error.message;
                if (msg.includes('must be enclosed in a user gesture')) msg = 'Haz clic de nuevo en el botón para conectar';
                alert(`Error al conectar impresora: ${msg}`);
                onPrinterDisconnected();
            }
        }

        function onPrinterDisconnected() {
            printerEndpoint = null;
            if (printerDevice) {
                printerDevice.close();
                printerDevice = null;
            }
            const btnText = document.getElementById('printer-status-text');
            if (btnText) btnText.textContent = 'Conectar Impresora';
            console.log('Impresora desconectada');
        }

        async function printTicket(employeeName, employeeNumber, dateStr) {
            if (!printerDevice || !printerEndpoint) {
                console.warn('No hay impresora USB conectada');
                // Opcional: intentar reconectar o avisar
                return;
            }

            try {

                const fechahoy = new Date().toLocaleDateString(); // Obtiene "16/02/2026"
                let ultimoDia = localStorage.getItem('fecha_consecutivo');
                let consecutivo = parseInt(localStorage.getItem('consecutivo_impresion') || '0');

                if (ultimoDia !== fechahoy) {
                    // Es un nuevo día (o primera vez), reiniciar
                    consecutivo = 1;
                    localStorage.setItem('fecha_consecutivo', fechahoy);
                } else {
                    // Mismo día, incrementar
                    consecutivo++;
                }
                localStorage.setItem('consecutivo_impresion', consecutivo);



                // Usar ThermalPrinterEncoder para generar comandos ESC/POS
                const encoder = new ThermalPrinterEncoder({
                    language: 'esc-pos', // Lenguaje ESC/POS (Corregido)
                    codepage: 'cp437'
                });

                // Construir ticket
                encoder
                    .initialize()
                    .newline()
                    .newline()
                    .newline()
                    .newline()
                    .align('center')
                    .bold(true)
                    .line('REGISTRO DE COMEDOR #' + String(consecutivo))
                    .bold(false)
                    .line('--------------------------------')
                    .align('left')
                    .line(`Nombre: ${employeeName}`)
                    .line(`N° Empleado: ${employeeNumber}`)
                    .line(`Fecha: ${dateStr}`)
                    .line('--------------------------------')
                    .newline()
                    .newline()
                    .newline()
                    .newline()
                    .newline()
                    .cut(); // Corte parcial

                const data = encoder.encode(); // Obtener Uint8Array

                // Enviar datos al endpoint USB
                await printerDevice.transferOut(printerEndpoint.endpointNumber, data);
                console.log('Impresión enviada por USB');

            } catch (error) {
                console.error('Error imprimiendo ticket:', error);
                alert('Error al imprimir: ' + error.message);
                onPrinterDisconnected(); // Asumir desconexión si falla escritura
            }
        }

        async function completeConsumptionRegistration() {
            const consumptionData = {
                employee_id: currentEmployeeForPIN.internal_id,
                comedor_id: appState.activeComedorId,
                consumption_date: new Date().toISOString().split('T')[0]
            };

            try {
                await apiRequest('/consumos', {
                    method: 'POST',
                    body: JSON.stringify(consumptionData)
                });

                showFullscreenMessage(true, '¡Validado!', 'Consumo registrado exitosamente');

                // --- IMPRESIÓN ---
                try {
                    const dateStr = new Date().toLocaleString('es-MX');
                    await printTicket(currentEmployeeForPIN.name, currentEmployeeForPIN.number || '', dateStr);
                } catch (printErr) {
                    console.error("Error intentando imprimir:", printErr);
                }
                // -----------------

                resetSearch();

            } catch (error) {
                console.error('Error registro online:', error);
                // 🔌 Fallback Offline
                try {
                    await OfflineDB.saveConsumption(consumptionData);
                    showFullscreenMessage(true, 'Guardado Offline', 'Consumo guardado localmente');

                    // --- IMPRESIÓN (También offline si la impresora funciona) ---
                    try {
                        const dateStr = new Date().toLocaleString('es-MX');
                        await printTicket(currentEmployeeForPIN.name, currentEmployeeForPIN.number || '', dateStr);
                    } catch (printErr) {
                        console.error("Error intentando imprimir:", printErr);
                    }
                    // -----------------------------------------------------------

                    resetSearch();
                } catch (dbError) {
                    showFullscreenMessage(false, 'Error Fatal', 'No se pudo guardar ni online ni offline');
                }
            }
        }

        function resetSearch() {
            setTimeout(() => {
                document.getElementById('employeeSearch').value = '';
                document.getElementById('search-results-container').classList.add('hidden');
                currentEmployeeForPIN = null;
            }, 2000);
        }

        async function syncOfflineData() {
            if (!navigator.onLine) return;

            try {
                const pending = await OfflineDB.getPendingConsumptions();
                if (pending.length === 0) return;

                console.log(`📡 Sincronizando ${pending.length} consumos offline...`);
                let syncedCount = 0;

                for (const item of pending) {
                    try {
                        await apiRequest('/consumos', {
                            method: 'POST',
                            body: JSON.stringify({
                                employee_id: item.employee_id,
                                comedor_id: item.comedor_id,
                                consumption_date: item.consumption_date
                            })
                        });
                        // Si tiene éxito, borrar de IDB
                        await OfflineDB.deleteConsumption(item.id);
                        syncedCount++;
                    } catch (err) {
                        console.error('Error sincronizando item:', item, err);
                    }
                }

                if (syncedCount > 0) {
                    console.log(`✅ Sincronizados ${syncedCount}/${pending.length} consumos`);
                    showFullscreenMessage(true, 'Sincronización', `${syncedCount} consumos subidos`);
                    // Recargar tabla de consumos actual
                    renderConsumosTable();
                }
            } catch (error) {
                console.error('Error en sync:', error);
            }
        }

        // Listener para cuando vuelve internet
        window.addEventListener('online', syncOfflineData);

        // Event Listeners para los modales de PIN
        document.getElementById('save-pin-button')?.addEventListener('click', completePINRegistration);

        document.getElementById('cancel-identity-button')?.addEventListener('click', () => {
            document.getElementById('confirm-identity-modal').classList.add('hidden');
            document.getElementById('employeeSearch').value = '';
            document.getElementById('search-results-container').classList.add('hidden');
            currentEmployeeForPIN = null;
        });

        document.getElementById('accept-identity-button')?.addEventListener('click', () => {
            showVerifyPINModal();
        });

        document.getElementById('cancel-verify-pin-button')?.addEventListener('click', () => {
            document.getElementById('verify-pin-modal').classList.add('hidden');
            document.getElementById('employeeSearch').value = '';
            document.getElementById('search-results-container').classList.add('hidden');
            currentEmployeeForPIN = null;
        });

        document.getElementById('verify-pin-button')?.addEventListener('click', verifyPINAndRegister);

        // Permitir Enter en los inputs de PIN
        document.getElementById('new-pin-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('confirm-pin-input').focus();
            }
        });

        document.getElementById('confirm-pin-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                completePINRegistration();
            }
        });

        document.getElementById('verify-pin-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                verifyPINAndRegister();
            }
        });

        // ============================================================================
        // GESTIÓN DE ACCIONES DE EMPLEADOS
        // ============================================================================

        window.handleEmployeeAction = function (action, employeeId, employeeName, employeeNumber) {
            // Resetear el select
            event.target.value = '';

            switch (action) {
                case 'edit':
                    editEmployee(employeeId, employeeName, employeeNumber);
                    break;
                case 'change_pin':
                    openChangePinModal(employeeId, employeeName);
                    break;
                case 'badge':
                    generateBadge(employeeId, employeeName, employeeNumber);
                    break;
                case 'delete':
                    deleteEmployee(employeeId);
                    break;
            }
        };

        function openChangePinModal(employeeId, employeeName) {
            const modal = document.getElementById('change-pin-modal');
            modal.classList.remove('hidden');

            document.getElementById('change-pin-employee-name').textContent = employeeName;
            document.getElementById('change-pin-employee-id').value = employeeId;
        }

        // Event listeners para el modal de cambio de PIN (Admin)
        document.getElementById('cancel-change-pin-button')?.addEventListener('click', () => {
            document.getElementById('change-pin-modal').classList.add('hidden');
        });

        document.getElementById('save-change-pin-button')?.addEventListener('click', async () => {
            const employeeId = document.getElementById('change-pin-employee-id').value;

            try {
                // Enviar pin: null para eliminarlo
                await apiRequest(`/empleados/${employeeId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ pin: null })
                });

                document.getElementById('change-pin-modal').classList.add('hidden');
                await loadAllData();
                showFullscreenMessage(true, 'Éxito', 'NIP eliminado correctamente');
            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        });

        function editEmployee(employeeId, employeeName, employeeNumber) {
            // Buscar el empleado completo en el estado
            const employee = appState.empleados.find(e => e.internal_id === employeeId);

            if (!employee) {
                alert('Empleado no encontrado');
                return;
            }

            // Mostrar modal
            const modal = document.getElementById('edit-employee-modal');
            modal.classList.remove('hidden');

            // Cargar datos en el formulario
            document.getElementById('edit-employee-id').value = employeeId;
            document.getElementById('edit-employee-name').value = employee.name;
            document.getElementById('edit-employee-number').value = employee.number || '';

            // Cargar tipos en el select
            const tipoSelect = document.getElementById('edit-employee-tipo');
            tipoSelect.innerHTML = '<option value="">Sin tipo</option>';
            appState.tipos.forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo.id_tipo;
                option.textContent = tipo.descripcion;
                option.selected = employee.tipo_id === tipo.id_tipo;
                tipoSelect.appendChild(option);
            });
        }

        // Event listener para conectar impresora
        document.getElementById('connect-printer-button')?.addEventListener('click', connectPrinter);

        // Event listeners para el modal de edición
        document.getElementById('cancel-edit-employee-button')?.addEventListener('click', () => {
            document.getElementById('edit-employee-modal').classList.add('hidden');
        });

        document.getElementById('save-edit-employee-button')?.addEventListener('click', async () => {
            const employeeId = document.getElementById('edit-employee-id').value;
            const name = document.getElementById('edit-employee-name').value.trim();
            const number = document.getElementById('edit-employee-number').value.trim();
            const tipoId = document.getElementById('edit-employee-tipo').value;

            if (!name) {
                alert('El nombre es obligatorio');
                return;
            }

            try {
                // Preparar datos para actualizar
                const updateData = {
                    name: name
                };

                if (number) {
                    updateData.number = number;
                }

                if (tipoId) {
                    updateData.tipo_id = tipoId;
                }

                // Llamar al API para actualizar
                await apiRequest(`/empleados/${employeeId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updateData)
                });

                // Cerrar modal
                document.getElementById('edit-employee-modal').classList.add('hidden');

                // Recargar datos
                await loadAllData();

                showFullscreenMessage(true, 'Éxito', 'Empleado actualizado');
            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        });

        function generateBadge(employeeId, employeeName, employeeNumber) {
            // Mostrar modal
            const modal = document.getElementById('badge-modal');
            modal.classList.remove('hidden');

            // Actualizar nombre y número
            document.getElementById('badge-employee-name').textContent = employeeName;
            document.getElementById('badge-employee-number').textContent = employeeNumber ? `#${employeeNumber}` : 'Sin número';

            // Generar QR Code
            const qrContainer = document.getElementById('badge-qr-container');
            qrContainer.innerHTML = '';

            const qrData = employeeNumber || employeeId;

            // Usar la librería QRCode (window.QRCode de qrcode.min.js)
            if (window.QRCode && window.QRCode.toCanvas) {
                const canvas = document.createElement('canvas');
                qrContainer.appendChild(canvas);

                window.QRCode.toCanvas(canvas, qrData, {
                    width: 200,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                }, function (error) {
                    if (error) console.error('Error generando QR:', error);
                });
            } else {
                // Fallback: usar QRCode constructor (de qrcodejs)
                new QRCode(qrContainer, {
                    text: qrData,
                    width: 200,
                    height: 200,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        }

        // Event listeners para el modal de gafete
        document.getElementById('close-badge-button')?.addEventListener('click', () => {
            document.getElementById('badge-modal').classList.add('hidden');
        });

        document.getElementById('print-badge-button')?.addEventListener('click', () => {
            printBadge();
        });

        document.getElementById('download-badge-button')?.addEventListener('click', () => {
            downloadBadge();
        });

        function printBadge() {
            const badgeContent = document.getElementById('badge-content');
            const printWindow = window.open('', '_blank');

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Gafete de Empleado</title>
                    <style>
                        body {
                            margin: 0;
                            padding: 20px;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            min-height: 100vh;
                        }
                        .badge {
                            border: 4px solid #ccc;
                            border-radius: 12px;
                            padding: 24px;
                            text-align: center;
                            max-width: 400px;
                        }
                        img {
                            max-height: 96px;
                            margin-bottom: 16px;
                        }
                        canvas {
                            margin: 16px 0;
                        }
                        h3 {
                            font-size: 24px;
                            font-weight: bold;
                            margin: 8px 0;
                        }
                        p {
                            color: #666;
                            margin: 0;
                        }
                        @media print {
                            body {
                                padding: 0;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="badge">
                        ${badgeContent.innerHTML}
                    </div>
                    <script>
                        window.onload = function() {
                            window.print();
                            window.onafterprint = function() {
                                window.close();
                            };
                        };
                    <\/script>
</body>

</html>
`);

            printWindow.document.close();
        }

        async function downloadBadge() {
            const badgeContent = document.getElementById('badge-content');

            try {
                // Usar html2canvas para convertir el div a imagen
                const canvas = await html2canvas(badgeContent, {
                    backgroundColor: '#ffffff',
                    scale: 2
                });

                // Convertir canvas a blob
                canvas.toBlob(function (blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const employeeName = document.getElementById('badge-employee-name').textContent;
                    link.download = `gafete-${employeeName.replace(/\s+/g, '-')}.png`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                });
            } catch (error) {
                console.error('Error descargando gafete:', error);
                alert('Error al descargar el gafete. Intenta usar el botón de imprimir.');
            }
        }

        // Descargar todos los gafetes en ZIP
        document.getElementById('download-all-badges-button')?.addEventListener('click', async () => {
            if (appState.empleados.length === 0) {
                alert('No hay empleados para generar gafetes.');
                return;
            }

            if (!confirm(`¿Desea generar y descargar los gafetes de ${appState.empleados.length} empleados? Esto puede tomar un momento.`)) {
                return;
            }

            const zip = new JSZip();
            const folder = zip.folder("gafetes");
            const batchContainer = document.getElementById('batch-badge-container');
            const batchContent = document.getElementById('batch-badge-content');
            const qrContainer = document.getElementById('batch-badge-qr-container');
            const nameEl = document.getElementById('batch-badge-employee-name');
            const numEl = document.getElementById('batch-badge-employee-number');

            showFullscreenMessage(true, 'Generando...', 'Procesando gafetes... 0%');

            try {
                // Hacer visible momentáneamente (pero fuera de pantalla) para que html2canvas funcione bien
                // Ya está fixed top-0 left-0 pero opacity 0. html2canvas a veces necesita visualización.
                // Modificamos estilos para asegurar renderizado
                batchContainer.style.opacity = '1';
                batchContainer.style.zIndex = '-50'; // Detrás de todo

                let processed = 0;
                const errors = [];

                for (const emp of appState.empleados) {
                    try {
                        // Actualizar datos
                        nameEl.textContent = emp.name;
                        numEl.textContent = emp.number ? `#${emp.number}` : 'Sin número';
                        qrContainer.innerHTML = '';

                        const qrData = emp.number || emp.internal_id;

                        // Generar QR - Lógica robusta
                        if (typeof QRCode !== 'undefined' && typeof QRCode.toCanvas === 'function') {
                            // Opción A: node-qrcode
                            const canvas = document.createElement('canvas');
                            qrContainer.appendChild(canvas);

                            await new Promise((resolve, reject) => {
                                QRCode.toCanvas(canvas, qrData, {
                                    width: 200,
                                    margin: 2,
                                    color: { dark: '#000000', light: '#FFFFFF' }
                                }, (error) => {
                                    if (error) reject(error);
                                    else resolve();
                                });
                            });
                        } else if (typeof QRCode !== 'undefined') {
                            // Opción B: qrcodejs (constructor)
                            new QRCode(qrContainer, {
                                text: qrData,
                                width: 200,
                                height: 200,
                                colorDark: '#000000',
                                colorLight: '#ffffff',
                                correctLevel: (QRCode.CorrectLevel) ? QRCode.CorrectLevel.H : 2
                            });
                        } else {
                            throw new Error('Librería QRCode no encontrada');
                        }

                        // Esperar un tik para renderizado
                        await new Promise(r => setTimeout(r, 50));

                        // Capturar imagen
                        const blob = await new Promise((resolve) => {
                            html2canvas(batchContent, {
                                backgroundColor: '#ffffff',
                                scale: 2,
                                logging: false
                            }).then(canvas => {
                                canvas.toBlob(resolve, 'image/png');
                            });
                        });

                        if (blob) {
                            const filename = `${emp.name.replace(/[^a-z0-9]/yi, '_')}_${emp.number || 'SN'}.png`;
                            folder.file(filename, blob);
                        }

                        processed++;
                        if (processed % 5 === 0) {
                            showFullscreenMessage(true, 'Generando...', `Procesando gafetes... ${Math.round((processed / appState.empleados.length) * 100)}%`);
                        }

                    } catch (err) {
                        console.error('Error generando gafete para', emp.name, err);
                        errors.push(emp.name);
                    }
                }

                showFullscreenMessage(true, 'Comprimiendo...', 'Generando archivo ZIP...');

                const content = await zip.generateAsync({ type: "blob" });
                const comedorName = appState.comedores.find(c => c.comedor_id === appState.activeComedorId)?.comedor_nombre || 'Comedor';

                // Descargar
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = `Gafetes_${comedorName}_${new Date().toISOString().slice(0, 10)}.zip`;
                link.click();
                URL.revokeObjectURL(link.href);

                // Ocultar de nuevo
                batchContainer.style.opacity = '0';

                if (errors.length > 0) {
                    setTimeout(() => alert(`Proceso completado con ${errors.length} errores (ver consola).`), 500);
                } else {
                    showFullscreenMessage(true, '¡Listo!', 'Descarga iniciada');
                }

            } catch (error) {
                console.error('Error global generando masivo:', error);
                batchContainer.style.opacity = '0';
                showFullscreenMessage(false, 'Error', 'Falló la generación masiva');
            }
        });

        window.deleteEmployee = async function (employeeId) {
            if (!confirm('¿Estás seguro de eliminar este empleado?')) return;

            try {
                await apiRequest(`/empleados/${employeeId}`, { method: 'DELETE' });
                await loadAllData();
                showFullscreenMessage(true, 'Éxito', 'Empleado eliminado');
            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        };

        // ============================================================================
        // LÓGICA DE HISTORIAL
        // ============================================================================
        let currentHistorialDetails = [];
        let currentHistoryId = null;

        async function loadHistorial() {
            const container = document.getElementById('historia-table-container');
            if (!container) return;

            // Asegurar que estamos en la vista de lista
            document.getElementById('historia-list-view').classList.remove('hidden');
            document.getElementById('historia-detail-view').classList.add('hidden');

            try {
                container.innerHTML = '<p class="text-center py-4 text-gray-500">Cargando...</p>';

                const historial = await apiRequest(`/historial?comedor_id=${appState.activeComedorId || ''}&limit=20`);

                if (!historial || historial.length === 0) {
                    container.innerHTML = '<p class="text-center py-8 text-gray-500">No hay historial disponible.</p>';
                    return;
                }

                container.innerHTML = `
                    <table class="min-w-full bg-white text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-3 text-left">Semana (Inicio)</th>
                                <th class="px-4 py-3 text-left">Comedor</th>
                                <th class="px-4 py-3 text-left">Fecha de Guardado</th>
                                <th class="px-4 py-3 text-left">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${historial.map(h => `
                                <tr class="hover:bg-gray-50 cursor-pointer" onclick="viewHistorialDetail(${h.id}, '${h.week_id}')">
                                    <td class="px-4 py-3 font-medium text-blue-600">${h.week_id}</td>
                                    <td class="px-4 py-3 text-gray-600">${h.comedor_nombre}</td>
                                    <td class="px-4 py-3 text-gray-500">${new Date(h.save_date).toLocaleString()}</td>
                                    <td class="px-4 py-3">
                                        <button class="text-blue-600 hover:text-blue-800 font-bold" 
                                            onclick="event.stopPropagation(); viewHistorialDetail(${h.id}, '${h.week_id}')">
                                            Ver Detalles
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error cargando historial:', error);
                container.innerHTML = `<p class="text-center py-4 text-red-500">Error: ${error.message}</p>`;
            }
        }

        window.viewHistorialDetail = async function (historyId, weekId) {
            currentHistoryId = historyId;
            const detailContainer = document.getElementById('historia-detail-table-container');
            const subtitle = document.getElementById('historia-detail-subtitle');

            // Cambiar vistas
            document.getElementById('historia-list-view').classList.add('hidden');
            document.getElementById('historia-detail-view').classList.remove('hidden');

            subtitle.textContent = `Semana del: ${weekId}`;
            detailContainer.innerHTML = '<p class="text-center py-4 text-gray-500">Cargando detalles...</p>';

            try {
                const detalles = await apiRequest(`/historial/${historyId}/detalles`);
                currentHistorialDetails = detalles; // Guardar para exportar

                if (!detalles || detalles.length === 0) {
                    detailContainer.innerHTML = '<p class="text-center py-8 text-gray-500">Esta semana no tiene registros guardados.</p>';
                    return;
                }

                detailContainer.innerHTML = `
                    <table class="min-w-full bg-white text-sm border">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left border">Empleado</th>
                                <th class="px-4 py-2 text-left border">Número</th>
                                <th class="px-4 py-2 text-left border">Tipo</th>
                                
                                <th class="px-4 py-2 text-center border">Consumos</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${detalles.map(d => `
                                <tr class="hover:bg-gray-50 text-gray-700">
                                    <td class="px-4 py-2 border">${d.empleado_nombre || 'Desconocido'}</td>
                                    <td class="px-4 py-2 border">${d.empleado_numero || '-'}</td>
                                    <td class="px-4 py-2 border">${d.empleado_tipo || '-'}</td>
                                    
                                    <td class="px-4 py-2 border text-center font-bold">${d.consumption_count}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot class="bg-gray-100 font-bold">
                            <tr>
                                <td colspan="4" class="px-4 py-2 text-right border">Total General:</td>
                                <td class="px-4 py-2 text-center border">
                                    ${detalles.reduce((sum, d) => sum + parseInt(d.consumption_count || 0), 0)}
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                `;

            } catch (error) {
                console.error('Error cargando detalles:', error);
                detailContainer.innerHTML = `<p class="text-center py-4 text-red-500">Error: ${error.message}</p>`;
            }
        };

        // Botón Volver de Historia
        document.getElementById('back-to-historia-list')?.addEventListener('click', () => {
            document.getElementById('historia-detail-view').classList.add('hidden');
            document.getElementById('historia-list-view').classList.remove('hidden');
        });

        // Exportar Historia a Excel
        document.getElementById('export-historia-button')?.addEventListener('click', () => {
            if (!currentHistorialDetails || currentHistorialDetails.length === 0) {
                alert('No hay datos para exportar');
                return;
            }

            try {
                // Preparar datos para Excel
                const data = currentHistorialDetails.map(d => ({
                    'Nombre': d.empleado_nombre,
                    'Número': d.empleado_numero,
                    'Tipo': d.empleado_tipo,
                    'Día': d.day_name,
                    'Consumos': d.consumption_count
                }));

                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Historial Semana");

                const activeComedor = appState.comedores.find(c => c.comedor_id === appState.activeComedorId);
                const comedorName = activeComedor ? activeComedor.comedor_nombre : 'Comedor';
                const filename = `Historial_${comedorName}_${new Date().toISOString().slice(0, 10)}.xlsx`;

                XLSX.writeFile(wb, filename);
            } catch (error) {
                console.error('Error exportando:', error);
                alert('Error al exportar a Excel');
            }
        });

        // ============================================================================
        // UTILIDADES
        // ============================================================================
        // ============================================================================
        // SONIDOS
        // ============================================================================
        async function playSuccessSound() {
            try {
                await Tone.start();
                const synth = new Tone.Synth().toDestination();
                const now = Tone.now();
                // Arpegio ascendente feliz (Do-Mi-Sol)
                synth.triggerAttackRelease("C5", "16n", now);
                synth.triggerAttackRelease("E5", "16n", now + 0.1);
                synth.triggerAttackRelease("G5", "8n", now + 0.2);
            } catch (error) {
                console.log('Error reproduciendo sonido:', error);
            }
        }

        async function playErrorSound() {
            try {
                await Tone.start();
                const synth = new Tone.Synth({
                    oscillator: { type: "sawtooth" },
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 }
                }).toDestination();
                const now = Tone.now();
                // Dos tonos graves y disonantes
                synth.triggerAttackRelease("G2", "8n", now);
                synth.triggerAttackRelease("C2", "4n", now + 0.15);
            } catch (error) {
                console.log('Error reproduciendo sonido:', error);
            }
        }

        function showFullscreenMessage(isSuccess, title, message) {
            // Reproducir sonido correspondiente
            if (isSuccess) {
                playSuccessSound();
            } else {
                playErrorSound();
            }

            const container = document.getElementById('fullscreen-message-container');
            container.className = `fixed inset-0 z-[100] flex items-center justify-center text-white text-center transition-opacity duration-300 ${isSuccess ? 'bg-green-500' : 'bg-red-600'}`;
            container.innerHTML = `
                <div class="flex flex-col items-center p-4">
                    <h2 class="text-4xl font-bold mb-4">${title}</h2>
                    <p class="text-xl">${message}</p>
                </div>
            `;
            container.classList.remove('hidden');

            // Refocus input immediately (allowing "blind" typing if supported)
            const searchInput = document.getElementById('employeeSearch');
            if (searchInput) {
                searchInput.value = ''; // Clear previous input
                searchInput.focus();
            }

            setTimeout(() => {
                container.classList.add('hidden');
                // Refocus again when hiding, just in case
                if (searchInput) searchInput.focus();
            }, 3000);
        }

        function switchPage(pageId) {
            document.querySelectorAll('.page-container').forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId)?.classList.remove('hidden');
        }

        // ============================================================================
        // EVENT LISTENERS
        // ============================================================================
        // ============================================================================
        // EVENT LISTENERS
        // ============================================================================

        // Función para manejar el logout seguro
        function initiateSecureLogout() {
            if (confirm('¿Está seguro que desea cerrar sesión?')) {
                /*
                const modal = document.getElementById('logout-password-modal');
                const passwordInput = document.getElementById('logout-confirm-password');
                const errorMsg = document.getElementById('logout-error-msg');
                */
                /*
                if (modal) {
                    modal.classList.remove('hidden');
                    if (passwordInput) {
                        passwordInput.value = '';
                        passwordInput.focus();
                    }
                    if (errorMsg) errorMsg.classList.add('hidden');
                }
                */
                logout();

            }
        }

        // Listeners para botones de logout
        document.getElementById('logout-button')?.addEventListener('click', initiateSecureLogout);
        document.getElementById('logout-button-verificador')?.addEventListener('click', initiateSecureLogout);

        // Lógica del modal de logout
        document.getElementById('cancel-logout-btn')?.addEventListener('click', () => {
            document.getElementById('logout-password-modal').classList.add('hidden');
        });

        document.getElementById('confirm-logout-btn')?.addEventListener('click', async () => {
            const password = document.getElementById('logout-confirm-password').value;
            const errorMsg = document.getElementById('logout-error-msg');
            const btn = document.getElementById('confirm-logout-btn');

            if (!password) {
                if (errorMsg) {
                    errorMsg.textContent = 'Ingrese su contraseña';
                    errorMsg.classList.remove('hidden');
                }
                return;
            }

            try {
                // Deshabilitar botón
                btn.disabled = true;
                btn.textContent = 'Verificando...';

                const response = await fetch(`${API_URL}/auth/verify-password`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: appState.currentUser.id,
                        password: password
                    })
                });

                const data = await response.json();

                if (data.success && data.valid) {
                    logout();
                    document.getElementById('logout-password-modal').classList.add('hidden');
                } else {
                    if (errorMsg) {
                        errorMsg.textContent = 'Contraseña incorrecta';
                        errorMsg.classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error(error);
                if (errorMsg) {
                    errorMsg.textContent = 'Error de conexión';
                    errorMsg.classList.remove('hidden');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'Cerrar Sesión';
            }
        });

        // Logout button para la página principal (usuarios no admin)
        document.getElementById('logout-button-main')?.addEventListener('click', () => {
            ShowConfirmacionLogout();
        });

        const logoutVerificadorBtn = document.getElementById('logout-button-verificador');
        if (logoutVerificadorBtn) logoutVerificadorBtn.addEventListener('click', () => {
            if (confirm('¿Está seguro que desea cerrar sesión?')) {
                logout();
            }
        });

        document.getElementById('admin-comedor-selector')?.addEventListener('change', async (e) => {
            appState.activeComedorId = e.target.value;
            await loadAllData();
        });

        document.getElementById('add-employee-button')?.addEventListener('click', async () => {
            const number = document.getElementById('new-employee-id').value;
            const name = document.getElementById('new-employee-name').value;
            const tipoId = document.getElementById('new-employee-tipo').value;

            if (!name) {
                alert('El nombre es obligatorio');
                return;
            }

            // Validar que si no hay número, debe haber tipo
            if (!number && !tipoId) {
                alert('Debe ingresar un número o seleccionar un tipo');
                return;
            }

            try {
                await apiRequest('/empleados', {
                    method: 'POST',
                    body: JSON.stringify({
                        internal_id: crypto.randomUUID(),
                        comedor_id: appState.activeComedorId,
                        name: name,
                        number: number || null,
                        tipo_id: tipoId || null
                    })
                });

                document.getElementById('new-employee-id').value = '';
                document.getElementById('new-employee-name').value = '';
                document.getElementById('new-employee-tipo').value = '';
                await loadAllData();
                showFullscreenMessage(true, 'Éxito', 'Empleado agregado');
            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        });

        document.getElementById('admin-employee-search')?.addEventListener('input', (e) => {
            renderAdminTable(e.target.value);
        });

        document.getElementById('employeeSearch')?.addEventListener('input', async (e) => {
            const searchTerm = e.target.value.trim();
            const resultsContainer = document.getElementById('search-results-container');

            if (searchTerm.length < 2) { resultsContainer.classList.add('hidden'); return; } const
                filtered = appState.empleados.filter(emp =>
                    emp.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (emp.number && emp.number.includes(searchTerm))
                );

            if (filtered.length > 0) {
                resultsContainer.innerHTML = filtered.map(emp => `
    <div class="p-3 hover:bg-gray-100 cursor-pointer border-b" onclick="selectEmployee('${emp.internal_id}')">
        <div class="font-bold">${emp.name}</div>
        <div class="text-sm text-gray-600">${emp.number || 'Sin número'}</div>
    </div>
    `).join('');
                resultsContainer.classList.remove('hidden');
            } else {
                resultsContainer.classList.add('hidden');
            }
        });

        window.selectEmployee = function (employeeId) {
            const employee = appState.empleados.find(e => e.internal_id === employeeId);
            if (employee) {
                registerConsumption(employeeId);
            }
        };

        // Event listener para habilitar/deshabilitar select de tipo
        document.getElementById('new-employee-id')?.addEventListener('input', (e) => {
            const tipoSelect = document.getElementById('new-employee-tipo');
            if (!tipoSelect) return;

            if (e.target.value.trim()) {
                // Si hay número, deshabilitar tipo
                tipoSelect.disabled = true;
                tipoSelect.classList.add('bg-gray-100');
                tipoSelect.value = '';
            } else {
                // Si no hay número, habilitar tipo
                tipoSelect.disabled = false;
                tipoSelect.classList.remove('bg-gray-100');
            }
        });

        // Event listener para agregar tipo
        document.getElementById('add-tipo-button')?.addEventListener('click', async () => {
            const descripcion = document.getElementById('new-tipo-descripcion').value.trim();

            if (!descripcion) {
                alert('La descripción es obligatoria');
                return;
            }

            try {
                await apiRequest('/tipos', {
                    method: 'POST',
                    body: JSON.stringify({ descripcion })
                });

                document.getElementById('new-tipo-descripcion').value = '';
                await loadTipos();
                showFullscreenMessage(true, 'Éxito', 'Tipo agregado');
            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        });

        // Event listener para agregar comedor
        document.getElementById('add-comedor-button')?.addEventListener('click', async () => {
            const id = document.getElementById('new-comedor-id').value.trim();
            const nombre = document.getElementById('new-comedor-nombre').value.trim();
            const empresaId = document.getElementById('new-comedor-empresa').value.trim();

            if (!id || !nombre || !empresaId) {
                alert('Todos los campos son obligatorios');
                return;
            }

            try {
                await apiRequest('/comedores', {
                    method: 'POST',
                    body: JSON.stringify({
                        id: id,
                        name: nombre,
                        empresa_id: empresaId,
                        require_pin: true
                    })
                });

                document.getElementById('new-comedor-id').value = '';
                document.getElementById('new-comedor-nombre').value = '';
                document.getElementById('new-comedor-empresa').value = '';
                await loadAllData();
                renderComedoresTable();
                showFullscreenMessage(true, 'Éxito', 'Comedor agregado');
            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        });




        // Tabs de admin
        document.querySelectorAll('.admin-nav-button').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const page = e.target.dataset.adminPage;
                currentAdminPage = page;

                console.log('🔄 Cambiando a pestaña:', page);

                // Actualizar tabs
                document.querySelectorAll('.admin-nav-button').forEach(b => {
                    b.classList.remove('text-blue-600', 'border-blue-600', 'border-b-2');
                    b.classList.add('text-gray-500');
                });
                e.target.classList.add('text-blue-600', 'border-blue-600', 'border-b-2');
                e.target.classList.remove('text-gray-500');

                // Ocultar todas las páginas
                document.getElementById('admin-gestion-page').classList.add('hidden');
                document.getElementById('admin-consumos-page').classList.add('hidden');
                document.getElementById('admin-tipos-page').classList.add('hidden');
                document.getElementById('admin-comedores-page').classList.add('hidden');
                document.getElementById('admin-historia-page').classList.add('hidden');
                document.getElementById('admin-usuarios-page').classList.add('hidden');

                // Mostrar la página seleccionada
                if (page === 'gestion') {
                    document.getElementById('admin-gestion-page').classList.remove('hidden');
                } else if (page === 'consumos') {
                    document.getElementById('admin-consumos-page').classList.remove('hidden');
                    renderConsumosTable();
                } else if (page === 'tipos') {
                    document.getElementById('admin-tipos-page').classList.remove('hidden');
                    loadTipos();
                } else if (page === 'comedores') {
                    document.getElementById('admin-comedores-page').classList.remove('hidden');
                    renderComedoresTable();
                } else if (page === 'historia') {
                    document.getElementById('admin-historia-page').classList.remove('hidden');
                    loadHistorial();
                } else if (page === 'usuarios') {
                    document.getElementById('admin-usuarios-page').classList.remove('hidden');
                    loadUsers();
                }
            });
        });

        // ============================================================================
        // EVENT LISTENER - LOGIN
        // ============================================================================
        document.getElementById('login-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');

            errorDiv.classList.add('hidden');

            try {
                await login(email, password);
            } catch (error) {
                errorDiv.textContent = error.message || 'Credenciales inválidas';
                errorDiv.classList.remove('hidden');
            }
        });

        // Exportar Consumos
        document.getElementById('export-consumos-button')?.addEventListener('click', async () => {
            try {
                // Obtener datos frescos
                const consumos = await apiRequest(`/consumos/semana-actual/${appState.activeComedorId}`);

                if (!consumos || consumos.length === 0) {
                    alert('No hay datos para exportar');
                    return;
                }

                // Transformar datos para Excel
                const dataToExport = consumos.map(c => ({
                    'Empleado ID': c.employee_id,
                    'Nombre': c.employee_name,
                    'Fecha Consumo': new Date(c.consumption_date).toLocaleDateString(),
                    'Día': c.day_name,
                    'Cantidad': c.consumption_count,
                    'Comedor': c.comedor_name
                }));

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Consumos");

                const dateStr = new Date().toISOString().split('T')[0];
                XLSX.writeFile(workbook, `Consumos_${dateStr}.xlsx`);

            } catch (error) {
                console.error('Error exportando:', error);
                alert('Error al exportar: ' + error.message);
            }
        });

        // Importar Empleados
        document.getElementById('import-employees-file')?.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 }); // Header 1 means array of arrays

                // Asumimos formato: [ [Numero, Nombre], [123, Juan], ... ]
                // O header key: [ {Numero: 123, Nombre: Juan}, ... ]
                // Vamos a intentar detectar headers o usar indices 0 y 1.

                // Mejor usar json auto key si tienen headers
                const jsonDataObjects = XLSX.utils.sheet_to_json(firstSheet);

                let processedCount = 0;
                let skippedCount = 0;
                let errorCount = 0;

                console.log('Datos importados:', jsonDataObjects);

                // Normalizar keys
                const employeesToProcess = jsonDataObjects.map(row => {
                    // Buscar key que parezca numero y nombre
                    const activeKeys = Object.keys(row);
                    console.log('activeKeys', activeKeys);
                    const numberKey = activeKeys.find(k => k.toLowerCase().includes('numero') || k.toLowerCase().includes('emp') || k.toLowerCase().includes('id'));
                    const nameKey = activeKeys.find(k => k.toLowerCase().includes('nombre') || k.toLowerCase().includes('name'));

                    if (numberKey && nameKey) {
                        return { number: String(row[numberKey]).trim(), name: String(row[nameKey]).trim() };
                    }
                    return null;
                }).filter(x => x !== null);
                console.log('employeesToProcess', employeesToProcess);
                if (employeesToProcess.length === 0) {
                    alert('No se detectaron columnas válidas. Use cabeceras "NumeroEmpleado" y "NombreCompleto".');
                    return;
                }

                showFullscreenMessage(true, 'Procesando...', `Importando ${employeesToProcess.length} empleados...`);

                for (const emp of employeesToProcess) {
                    // Validar duplicado localmente primero para ahorrar request
                    const exists = appState.empleados.some(e => e.number === emp.number);
                    if (exists) {
                        console.warn(`Duplicado omitido: ${emp.number} - ${emp.name}`);
                        skippedCount++;
                        continue;
                    }

                    try {
                        await apiRequest('/empleados', {
                            method: 'POST',
                            body: JSON.stringify({
                                internal_id: crypto.randomUUID(),
                                comedor_id: appState.activeComedorId,
                                name: emp.name,
                                number: emp.number,
                                type: 'General' // Default type
                            })
                        });
                        processedCount++;
                    } catch (err) {
                        console.error('Error guardando empleado importado:', err);
                        errorCount++;
                    }
                }

                e.target.value = ''; // Reset input
                await loadAllData();
                alert(`Importación completada:\n✅ Agregados: ${processedCount}\n⏭️ Duplicados (omitidos): ${skippedCount}\n❌ Errores: ${errorCount}`);

            } catch (error) {
                console.error('Error procesando archivo:', error);
                alert('Error al procesar archivo: ' + error.message);
                e.target.value = '';
            }
        });

        // ============================================================================
        // LISTENER GLOBAL PARA TECLADO (BUSQUEDA Y SCANNER)
        // ============================================================================

        window.addEventListener('keydown', (e) => {
            // Priority: Modal de Confirmación de Identidad
            const confirmModal = document.getElementById('confirm-identity-modal');
            if (confirmModal && !confirmModal.classList.contains('hidden')) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('accept-identity-button')?.click();
                    return;
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    document.getElementById('cancel-identity-button')?.click();
                    return;
                }
                // Bloquear otras interacciones de teclado si el modal está abierto
                return;
            }

            // Ignorar si estamos en un input/textarea que NO sea el de búsqueda
            const activeElem = document.activeElement;
            const isInput = activeElem.tagName === 'INPUT' || activeElem.tagName === 'TEXTAREA';
            const searchInput = document.getElementById('employeeSearch');

            if (!searchInput) return;

            // Si el foco está en otro input (ej. modal), no interferir
            if (isInput && activeElem.id !== 'employeeSearch') {
                return;
            }

            // Manejo de Enter
            if (e.key === 'Enter') {
                const searchTerm = searchInput.value.trim();
                // Intentar buscar inmediatamente
                if (searchTerm) {
                    console.log('🔍 Enter detectado, buscando:', searchTerm);
                    selectEmployeeByData(searchTerm);
                    e.preventDefault();
                }
            }
            // Manejo de Backspace
            else if (e.key === 'Backspace') {
                // Si NO estamos en el input, manejar el borrado manualmente
                if (activeElem.id !== 'employeeSearch') {
                    e.preventDefault(); // Evitar navegar atrás
                    const val = searchInput.value;
                    searchInput.value = val.substring(0, val.length - 1);
                    searchInput.dispatchEvent(new Event('input'));
                    searchInput.focus(); // Enfocar para feedback visual
                }
            }
            // Manejo de caracteres normales (letras, números, símbolos)
            else if (e.key.length === 1 && !e.ctrlKey && !e.altKey && !e.metaKey) {
                // Si NO estamos en el input, agregar el caracter manualmente
                if (activeElem.id !== 'employeeSearch') {
                    e.preventDefault();
                    searchInput.value += e.key;
                    searchInput.dispatchEvent(new Event('input'));
                    searchInput.focus(); // Enfocar para feedback visual
                }
            }
        });

        // Nueva función auxiliar para buscar empleado por ID o Número exacto
        async function selectEmployeeByData(data) {
            // Buscar en el estado local por number o internal_id
            const employee = appState.empleados.find(e =>
                (e.number && e.number === data) ||
                (e.internal_id === data)
            );

            if (employee) {
                registerConsumption(employee.internal_id);
                // Limpiar búsqueda tras éxito
                const searchInput = document.getElementById('employeeSearch');
                if (searchInput) {
                    searchInput.value = '';
                    searchInput.dispatchEvent(new Event('input')); // Ocultar resultados
                    searchInput.blur(); // Quitar foco
                }
            } else {
                console.warn('Empleado no encontrado con datos exactos:', data);
                // Si no es coincidencia exacta, dejamos que el usuario vea la lista filtrada
                // que ya se actualizó con el evento 'input'
            }
        }

        // ============================================================================
        // INICIALIZACIÓN
        // ============================================================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 Sistema de Comedor - PostgreSQL');
            console.log('📡 API:', API_URL);

            // Inicializar BD Offline
            try {
                await OfflineDB.initDB();
            } catch (e) {
                console.error('Error inicializando OfflineDB', e);
            }

            // Ocultar loading overlay
            document.getElementById('loading-overlay').style.display = 'none';

            // Verificar si hay sesión guardada
            if (checkAuth()) {
                console.log('✅ Usuario autenticado:', appState.currentUser);

                // Actualizar nombre de usuario
                updateUserDisplay();

                // Cargar datos
                await loadAllData();

                // Mostrar página según rol
                if (appState.currentUser.role === 'administrador') {
                    switchPage('admin-dashboard-page');
                } else if (appState.currentUser.role === 'verificador') {
                    switchPage('verificador-dashboard-page');
                    initVerificadorDashboard();
                } else {
                    switchPage('main-page');
                }

                // Auto-refresh cada 10 segundos
                setInterval(loadAllData, 10000);
            } else {
                console.log('❌ No hay sesión activa');
                switchPage('login-page');
            }
        });
        // ============================================================================
        // VERIFICADOR DASHBOARD
        // ============================================================================

        function initVerificadorDashboard() {
            if (socket) return; // Ya inicializado

            console.log('Iniciando Dashboard de Verificador...');

            if (typeof window.io === 'undefined') {
                console.error('Socket.IO no está cargado');
                alert('Error: No se pudo conectar al servicio de tiempo real. Verifique su conexión internet (CDN).');
                return;
            }

            socket = window.io(API_URL.replace('/api', ''));

            const statusIndicator = document.getElementById('socket-status-indicator');
            const statusText = document.getElementById('socket-status-text');
            const tbody = document.getElementById('real-time-log-body');

            // --- TABS LOGIC ---
            // Initial query
            let tabRealtime = document.getElementById('tab-verificador-realtime');
            let tabHistory = document.getElementById('tab-verificador-history');
            const viewRealtime = document.getElementById('verificador-realtime-view');
            const viewHistory = document.getElementById('verificador-history-view');

            function switchVerificadorTab(tab) {
                // Re-query elements to ensure we have the live ones after replacement
                const currentTabRealtime = document.getElementById('tab-verificador-realtime');
                const currentTabHistory = document.getElementById('tab-verificador-history');

                // Clases activos: border-blue-500 text-blue-600 font-bold
                // Clases inactivos: border-transparent text-gray-500 font-medium

                if (tab === 'realtime') {
                    // Activar Realtime
                    currentTabRealtime.classList.remove('border-transparent', 'text-gray-500', 'font-medium');
                    currentTabRealtime.classList.add('border-blue-500', 'text-blue-600', 'font-bold');

                    // Desactivar History
                    currentTabHistory.classList.remove('border-blue-500', 'text-blue-600', 'font-bold');
                    currentTabHistory.classList.add('border-transparent', 'text-gray-500', 'font-medium');

                    viewRealtime.classList.remove('hidden');
                    viewHistory.classList.add('hidden');
                } else {
                    // Activar History
                    currentTabHistory.classList.remove('border-transparent', 'text-gray-500', 'font-medium');
                    currentTabHistory.classList.add('border-blue-500', 'text-blue-600', 'font-bold');

                    // Desactivar Realtime
                    currentTabRealtime.classList.remove('border-blue-500', 'text-blue-600', 'font-bold');
                    currentTabRealtime.classList.add('border-transparent', 'text-gray-500', 'font-medium');

                    viewHistory.classList.remove('hidden');
                    viewRealtime.classList.add('hidden');
                    loadTodayConsumptions();
                }
            }

            if (tabRealtime && tabHistory) {
                const newRealtime = tabRealtime.cloneNode(true);
                const newHistory = tabHistory.cloneNode(true);
                tabRealtime.parentNode.replaceChild(newRealtime, tabRealtime);
                tabHistory.parentNode.replaceChild(newHistory, tabHistory);

                newRealtime.addEventListener('click', () => switchVerificadorTab('realtime'));
                newHistory.addEventListener('click', () => switchVerificadorTab('history'));
            }

            // --- HISTORY LOGIC ---
            const historyBody = document.getElementById('verificador-history-body');
            const historySearch = document.getElementById('verificador-history-search');
            const refreshHistoryBtn = document.getElementById('refresh-history-btn');

            async function loadTodayConsumptions() {
                if (!historyBody) return;
                historyBody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Cargando...</td></tr>';
                try {
                    // Obtener consumos de hoy
                    let url = `${API_URL}/consumos/hoy?comedor_id=${appState.currentUser.comedorId || ''}`;
                    if (historySearch && historySearch.value.trim()) {
                        url += `&search=${encodeURIComponent(historySearch.value.trim())}`;
                    }

                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Error cargando historial');
                    const consumptions = await response.json();

                    historyBody.innerHTML = '';
                    if (consumptions.length === 0) {
                        historyBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No hay consumos registrados hoy.</td></tr>';
                        return;
                    }

                    consumptions.forEach(c => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                             <td class="px-5 py-5 border-b border-gray-200 text-sm">${new Date(c.created_at).toLocaleTimeString()}</td>
                             <td class="px-5 py-5 border-b border-gray-200 text-sm font-bold text-gray-700">${c.employee_name}</td>
                             <td class="px-5 py-5 border-b border-gray-200 text-sm">${c.employee_number || '-'}</td>
                             <td class="px-5 py-5 border-b border-gray-200 text-sm">${c.employee_type || '-'}</td>
                             <td class="px-5 py-5 border-b border-gray-200 text-sm">${c.comedor_name}</td>
                        `;
                        historyBody.appendChild(row);
                    });

                } catch (error) {
                    console.error(error);
                    historyBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">Error: ${error.message}</td></tr>`;
                }
            }

            if (historySearch) {
                // Debounce search
                let timeout = null;
                const newSearch = historySearch.cloneNode(true);
                historySearch.parentNode.replaceChild(newSearch, historySearch);

                newSearch.addEventListener('input', () => {
                    clearTimeout(timeout);
                    timeout = setTimeout(loadTodayConsumptions, 300);
                });
            }
            if (refreshHistoryBtn) {
                const newRefresh = refreshHistoryBtn.cloneNode(true);
                refreshHistoryBtn.parentNode.replaceChild(newRefresh, refreshHistoryBtn);
                newRefresh.addEventListener('click', loadTodayConsumptions);
            }

            // --- SOCKET LOGIC ---

            socket.on('connect', () => {
                console.log('Socket conectado');
                if (statusIndicator) {
                    statusIndicator.classList.remove('bg-red-500');
                    statusIndicator.classList.add('bg-green-500', 'animate-pulse');
                }
                if (statusText) statusText.textContent = 'Conectado';
            });

            socket.on('disconnect', () => {
                console.log('Socket desconectado');
                if (statusIndicator) {
                    statusIndicator.classList.remove('bg-green-500', 'animate-pulse');
                    statusIndicator.classList.add('bg-red-500');
                }
                if (statusText) statusText.textContent = 'Desconectado';
            });

            socket.on('new_consumption', (data) => {
                console.log('Nuevo consumo recibido:', data);

                // Crear fila
                const row = document.createElement('tr');
                const rowId = `row-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                row.id = rowId;
                row.className = 'bg-green-50 transition-all duration-1000'; // Added transition-all

                const timeStr = new Date(data.timestamp).toLocaleTimeString();

                row.innerHTML = `
                    <td class="px-5 py-5 border-b border-gray-200 text-sm">
                        <p class="text-gray-900 whitespace-no-wrap font-bold">${timeStr}</p>
                    </td>
                    <td class="px-5 py-5 border-b border-gray-200 text-sm">
                        <p class="text-gray-900 whitespace-no-wrap">${data.employee_name}</p>
                    </td>
                    <td class="px-5 py-5 border-b border-gray-200 text-sm">
                        <p class="text-gray-900 whitespace-no-wrap">${data.employee_number || '-'}</p>
                    </td>
                    <td class="px-5 py-5 border-b border-gray-200 text-sm">
                        <p class="text-gray-900 whitespace-no-wrap">${data.employee_type || '-'}</p>
                    </td>
                    <td class="px-5 py-5 border-b border-gray-200 text-sm">
                        <p class="text-gray-900 whitespace-no-wrap">${data.comedor_name}</p>
                    </td>
                    <td class="px-5 py-5 border-b border-gray-200 text-sm">
                        <button onclick="confirmValidation('${rowId}', '${data.employee_name.replace(/'/g, "\\'")}', '${(data.employee_number || '').replace(/'/g, "\\'")}')" 
                                class="bg-green-100 hover:bg-green-200 text-green-800 p-2 rounded-full transition-colors focus:outline-none"
                                title="Validar y quitar de la lista">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                            </svg>
                        </button>
                    </td>
                `;

                // Insertar al principio
                tbody.insertBefore(row, tbody.firstChild);

                // Efecto de highlight
                setTimeout(() => {
                    row.classList.remove('bg-green-50');
                    row.classList.add('bg-white');
                }, 2000);

                // Limitar a las últimas 50 filas
                if (tbody.children.length > 50) {
                    tbody.removeChild(tbody.lastChild);
                }
            });
        }

        // ============================================================================
        // GESTIÓN DE USUARIOS
        // ============================================================================

        async function loadUsers() {
            try {
                const users = await apiRequest('/users');
                renderUsersTable(users);
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                showFullscreenMessage(false, 'Error', 'No se pudieron cargar los usuarios');
            }
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('admin-users-table-body');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                        <div class="flex items-center">
                            <div class="ml-3">
                                <p class="text-gray-900 whitespace-no-wrap font-bold">
                                    ${user.email}
                                </p>
                            </div>
                        </div>
                    </td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                        <p class="text-gray-900 whitespace-no-wrap">${user.full_name}</p>
                    </td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                        <span class="relative inline-block px-3 py-1 font-semibold leading-tight">
                            <span aria-hidden class="absolute inset-0 ${user.role === 'administrador' ? 'bg-purple-200' : 'bg-blue-200'} opacity-50 rounded-full"></span>
                            <span class="relative ${user.role === 'administrador' ? 'text-purple-900' : 'text-blue-900'}">${user.role}</span>
                        </span>
                    </td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                         <p class="text-gray-900 whitespace-no-wrap">
                            ${user.comedor_id ? (appState.comedores.find(c => c.id === user.comedor_id)?.name || user.comedor_id) : 'Global'}
                        </p>
                    </td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                        <span class="relative inline-block px-3 py-1 font-semibold text-green-900 leading-tight">
                            <span aria-hidden class="absolute inset-0 ${user.active ? 'bg-green-200' : 'bg-red-200'} opacity-50 rounded-full"></span>
                            <span class="relative">${user.active ? 'Activo' : 'Inactivo'}</span>
                        </span>
                    </td>
                    <td class="px-5 py-5 border-b border-gray-200 bg-white text-sm">
                        <div class="flex gap-2">
                            <button onclick="openEditUserModal('${user.id}')" class="text-blue-600 hover:text-blue-900">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button onclick="openChangePasswordModal('${user.id}', '${user.email}')" class="text-yellow-600 hover:text-yellow-900" title="Cambiar Contraseña">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11.536 19.464a3 3 0 01-1.414.88l-4.243.848a1 1 0 01-1.213-1.213l.849-4.243a3 3 0 01.88-1.414l3.364-3.364 1.757-1.757m0 0a6 6 0 10-8.486 8.486 1.757 1.757 0 111.757 1.757" />
                                </svg>
                            </button>
                             <button onclick="deleteUser('${user.id}')" class="text-red-600 hover:text-red-900">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // --- Modales ---
        const manageUserModal = document.getElementById('manage-user-modal');
        const changeUserPassModal = document.getElementById('change-user-password-modal');

        // Populate Comedor Select
        function populateComedorSelect() {
            const select = document.getElementById('manage-user-comedor');
            //manage-user-role
            const selectrole = document.getElementById('manage-user-role');

            //limpiar select
            select.innerHTML = '';
            selectrole.innerHTML = '';


            //Agregar los roles administrador, monitor y verificador
            const roles = ['administrador', 'monitor', 'verificador'];
            roles.forEach(role => {
                const option = document.createElement('option');
                console.log("role", role);
                option.value = role;
                option.textContent = role;
                selectrole.appendChild(option);
            });
            // Keep first option (Ninguno/Global)
            //select.innerHTML = '<option value="">Ninguno (Global - Acceso a todos)</option>';
            console.log("appState.comedores", appState.comedores);
            appState.comedores.forEach(comedor => {
                const option = document.createElement('option');
                option.value = comedor.comedor_id;
                option.textContent = comedor.comedor_nombre;
                select.appendChild(option);
            });
        }

        document.getElementById('btn-add-user')?.addEventListener('click', () => {
            document.getElementById('manage-user-modal-title').textContent = 'Agregar Usuario';
            document.getElementById('manage-user-id').value = '';
            document.getElementById('manage-user-email').value = '';
            document.getElementById('manage-user-fullname').value = '';
            document.getElementById('manage-user-password').value = '';
            document.getElementById('manage-user-role').value = 'administrador';
            document.getElementById('manage-user-comedor').value = '';
            document.getElementById('manage-user-password-container').classList.remove('hidden');

            populateComedorSelect();
            manageUserModal.classList.remove('hidden');
        });

        window.openEditUserModal = async function (userId) {
            try {
                // Fetch info del usuario o buscar en tabla si ya la tenemos (mejor fetch para asegurar frescura)
                // Usamos la lista cargada en memoria por simplicidad por ahora, 
                // pero si el endpoint GET /users/:id existiera sería mejor.
                // Como cargamos users al entrar al tab, buscamos en el DOM o re-fetcheamos.
                // Re-fetcheamos todos para encontrarlo.
                const users = await apiRequest('/users');
                const user = users.find(u => u.id === userId);

                if (!user) throw new Error('Usuario no encontrado');

                document.getElementById('manage-user-modal-title').textContent = 'Editar Usuario';
                document.getElementById('manage-user-id').value = user.id;
                document.getElementById('manage-user-email').value = user.email;
                document.getElementById('manage-user-fullname').value = user.full_name;
                // No mostramos password al editar
                document.getElementById('manage-user-password-container').classList.add('hidden');
                document.getElementById('manage-user-password').value = '';

                document.getElementById('manage-user-role').value = user.role;

                populateComedorSelect();
                document.getElementById('manage-user-comedor').value = user.comedor_id || '';

                manageUserModal.classList.remove('hidden');
            } catch (e) {
                console.error(e);
                alert('Error al cargar datos del usuario');
            }
        };

        document.getElementById('btn-cancel-user')?.addEventListener('click', () => {
            manageUserModal.classList.add('hidden');
        });

        document.getElementById('btn-save-user')?.addEventListener('click', async () => {
            const id = document.getElementById('manage-user-id').value;
            const email = document.getElementById('manage-user-email').value;
            const full_name = document.getElementById('manage-user-fullname').value;
            const password = document.getElementById('manage-user-password').value;
            const role = document.getElementById('manage-user-role').value;
            const comedor_id = document.getElementById('manage-user-comedor').value;

            if (!email || !full_name || !role) {
                alert('Faltan campos requeridos');
                return;
            }

            if (!id && !password) {
                alert('La contraseña es requerida para nuevos usuarios');
                return;
            }

            const payload = {
                email,
                full_name,
                role,
                comedor_id: comedor_id || null,
                active: true
            };

            if (!id) {
                payload.password = password;
            }

            try {
                const url = id ? `/users/${id}` : '/users';
                const method = id ? 'PUT' : 'POST';

                await apiRequest(url, {
                    method: method,
                    body: JSON.stringify(payload)
                });

                manageUserModal.classList.add('hidden');
                loadUsers();
                showFullscreenMessage(true, 'Éxito', id ? 'Usuario actualizado' : 'Usuario creado');
            } catch (error) {
                console.error(error);
                alert('Error al guardar usuario: ' + error.message);
            }
        });

        // --- Change Password Modal ---
        window.openChangePasswordModal = function (userId, userEmail) {
            document.getElementById('change-pass-user-id').value = userId;
            document.getElementById('change-pass-user-email').textContent = userEmail;
            document.getElementById('new-user-password').value = '';
            changeUserPassModal.classList.remove('hidden');
        }

        document.getElementById('btn-cancel-pass')?.addEventListener('click', () => {
            changeUserPassModal.classList.add('hidden');
        });

        document.getElementById('btn-save-pass')?.addEventListener('click', async () => {
            const id = document.getElementById('change-pass-user-id').value;
            const password = document.getElementById('new-user-password').value;

            if (!password) {
                alert('Debe ingresar una contraseña');
                return;
            }

            try {
                await apiRequest(`/users/${id}/password`, {
                    method: 'PUT',
                    body: JSON.stringify({ password })
                });

                changeUserPassModal.classList.add('hidden');
                showFullscreenMessage(true, 'Éxito', 'Contraseña actualizada');
            } catch (error) {
                console.error(error);
                alert('Error al cambiar contraseña: ' + error.message);
            }
        });

        // --- Delete User ---
        window.deleteUser = async function (userId) {
            if (!confirm('¿Está seguro de que desea eliminar este usuario? Esta acción no se puede deshacer.')) return;

            try {
                await apiRequest(`/users/${userId}`, {
                    method: 'DELETE'
                });
                loadUsers();
                showFullscreenMessage(true, 'Éxito', 'Usuario eliminado');
            } catch (error) {
                console.error(error);
                alert('Error al eliminar usuario: ' + error.message);
            }
        }

        // Search Filter
        document.getElementById('admin-users-search')?.addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#admin-users-table-body tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(term)) {
                    row.classList.remove('hidden');
                } else {
                    row.classList.add('hidden');
                }
            });
        });

        // ===================================
        // HELPERS GLOBALES PARA VERIFICADOR
        // ===================================
        window.ShowConfirmacionLogout = function () {
            const modal = document.getElementById('logout-password-modal');
            const passwordInput = document.getElementById('logout-confirm-password');
            const errorMsg = document.getElementById('logout-error-msg');

            if (passwordInput) passwordInput.value = '';
            if (errorMsg) errorMsg.classList.add('hidden');

            if (modal) {
                modal.classList.remove('hidden');
                setTimeout(() => passwordInput?.focus(), 100);
            }
        };

        // ===================================
        window.confirmValidation = function (rowId, name, number) {
            const modal = document.getElementById('validate-consumption-modal');
            const nameSpan = document.getElementById('validate-emp-name');
            const numberSpan = document.getElementById('validate-emp-number');
            const rowIdInput = document.getElementById('validate-row-id');

            if (nameSpan) nameSpan.textContent = name;
            if (numberSpan) numberSpan.textContent = number;
            if (rowIdInput) rowIdInput.value = rowId;

            if (modal) modal.classList.remove('hidden');
        };

        const cancelValidateBtn = document.getElementById('cancel-validate-button');
        if (cancelValidateBtn) {
            cancelValidateBtn.addEventListener('click', () => {
                document.getElementById('validate-consumption-modal').classList.add('hidden');
            });
        }

        const confirmValidateBtn = document.getElementById('confirm-validate-button');
        if (confirmValidateBtn) {
            confirmValidateBtn.addEventListener('click', () => {
                const rowId = document.getElementById('validate-row-id').value;
                const row = document.getElementById(rowId);

                if (row) {
                    // Fade out
                    row.classList.add('opacity-0');
                    setTimeout(() => {
                        row.remove();
                    }, 500);
                }
                document.getElementById('validate-consumption-modal').classList.add('hidden');
            });
        }

    </script>
</body>

</html>