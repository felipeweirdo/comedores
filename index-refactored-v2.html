<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro de Comida - PostgreSQL</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Tone.js para sonidos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <!-- QR Code Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

    <!-- html2canvas para descargar gafete -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- SheetJS para Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="styles.css">
</head>

<body class="bg-gray-100">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-[200] flex items-center justify-center">
        <div class="text-xl font-bold text-gray-700">Cargando sistema...</div>
    </div>

    <!-- P√ÅGINA DE LOGIN -->
    <div id="login-page"
        class="page-container hidden flex items-center justify-center p-4 min-h-screen bg-gradient-to-br from-blue-500 to-purple-600">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <img src="https://i.imgur.com/4SmaZVt.png" crossorigin="anonymous" alt="Logo"
                    class="mx-auto h-32 w-auto mb-4">
                <h1 class="text-3xl font-bold text-gray-800">Sistema de Comedor</h1>
                <p class="text-gray-500 mt-2">Inicie sesi√≥n para continuar</p>
            </div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-email" class="block text-gray-700 text-sm font-bold mb-2">
                        Correo Electr√≥nico
                    </label>
                    <input type="email" id="login-email" required
                        class="shadow-inner appearance-none border-2 border-gray-200 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="usuario@ejemplo.com">
                </div>

                <div>
                    <label for="login-password" class="block text-gray-700 text-sm font-bold mb-2">
                        Contrase√±a
                    </label>
                    <input type="password" id="login-password" required
                        class="shadow-inner appearance-none border-2 border-gray-200 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <div id="login-error"
                    class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg text-sm">
                </div>

                <button type="submit"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transform hover:scale-105 transition-transform duration-200">
                    Iniciar Sesi√≥n
                </button>
            </form>

            <div class="mt-6 text-center text-sm text-gray-600">
                <p>Usuario de prueba: <strong>admin@comedor.com</strong></p>
            </div>
        </div>
    </div>

    <!-- P√ÅGINA PRINCIPAL: REGISTRO -->
    <div id="main-page" class="page-container flex items-center justify-center p-4 min-h-screen relative">
        <!-- Informaci√≥n del usuario (solo visible para usuarios no admin) -->
        <div id="user-info-badge" class="fixed top-4 left-4 bg-white text-gray-800 py-2 px-4 rounded-lg shadow-lg z-30">
            <div class="flex items-center gap-2 mb-1">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <span id="user-name-display" class="font-semibold">Usuario</span>
            </div>
            <div class="flex items-center gap-2 text-sm text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-600" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
                <span id="comedor-name-display">Comedor</span>
            </div>
        </div>

        <!-- Bot√≥n Cerrar Sesi√≥n (solo visible para usuarios no admin) -->
        <button id="logout-button-main"
            class="fixed top-4 right-4 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg z-30 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            Cerrar Sesi√≥n
        </button>

        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <img src="https://i.imgur.com/4SmaZVt.png" crossorigin="anonymous" alt="Logo"
                class="mx-auto h-36 w-auto mb-6">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">Registro de Comida</h1>
            <p class="text-center text-gray-500 mb-6">Busque por nombre o n√∫mero de empleado</p>

            <div class="mb-4 relative text-left">
                <label for="employeeSearch" class="block text-gray-700 text-sm font-bold mb-2">Buscar Empleado:</label>
                <div id="search-results-container"
                    class="absolute bottom-full left-0 right-0 bg-white border mb-1 rounded-lg shadow-lg z-10 max-h-60 overflow-y-auto hidden">
                </div>
                <input type="text" id="employeeSearch"
                    class="shadow-inner appearance-none border-2 border-gray-200 rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Ej: Juan Perez o 12345" autocomplete="off">
            </div>

            <button id="submitButton"
                class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:shadow-outline transform hover:scale-105 transition-transform duration-200">Aceptar</button>
        </div>
    </div>

    <!-- P√ÅGINA ADMIN -->
    <div id="admin-dashboard-page"
        class="page-container hidden container mx-auto p-4 space-y-8 mt-24 md:mt-16 lg:mt-12">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Panel de Administraci√≥n</h1>
            <button id="logout-button"
                class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Cerrar Sesi√≥n</button>
        </div>

        <div class="bg-white p-4 rounded-2xl shadow-lg flex items-center justify-between">
            <label for="admin-comedor-selector" class="font-bold text-gray-600 mr-2">Comedor Activo:</label>
            <select id="admin-comedor-selector" class="p-2 border-2 border-gray-200 rounded-lg flex-grow"></select>
        </div>

        <!-- Tabs -->
        <div class="flex flex-wrap border-b border-gray-200">
            <button data-admin-page="gestion"
                class="admin-nav-button py-2 px-4 font-semibold text-blue-600 border-b-2 border-blue-600">Gesti√≥n de
                Empleados</button>
            <button data-admin-page="consumos"
                class="admin-nav-button py-2 px-4 font-semibold text-gray-500 hover:text-blue-600">Consumos</button>
            <button data-admin-page="tipos"
                class="admin-nav-button py-2 px-4 font-semibold text-gray-500 hover:text-blue-600">Tipos</button>
            <button data-admin-page="comedores"
                class="admin-nav-button py-2 px-4 font-semibold text-gray-500 hover:text-blue-600">Comedores</button>
        </div>

        <!-- Contenido Admin -->
        <div id="admin-content-container">
            <!-- Gesti√≥n de Empleados -->
            <div id="admin-gestion-page">
                <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                    <h2 class="text-xl font-bold text-gray-700 mb-4">Gestionar Empleados</h2>

                    <div class="grid md:grid-cols-4 gap-4 mb-6">
                        <input type="number" id="new-employee-id" placeholder="N√∫mero (Opcional)"
                            class="p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="new-employee-name" placeholder="Nombre Completo"
                            class="p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="new-employee-tipo"
                            class="p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Seleccione tipo...</option>
                        </select>
                        <button id="add-employee-button"
                            class="md:col-span-1 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">Agregar
                            Empleado</button>
                    </div>

                    <div class="mb-4 flex gap-4">
                        <input type="text" id="admin-employee-search" placeholder="Buscar empleado..."
                            class="flex-grow p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">

                        <!-- Importar Empleados -->
                        <div class="flex items-center">
                            <input type="file" id="import-employees-file" accept=".csv, .xlsx, .xls" class="hidden">
                            <button onclick="document.getElementById('import-employees-file').click()"
                                class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Importar CSV/Excel
                            </button>
                        </div>
                    </div>

                    <div id="admin-table-container" class="overflow-x-auto"></div>
                </div>
            </div>

            <!-- Consumos -->
            <div id="admin-consumos-page" class="hidden">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-gray-700">Consumos de la Semana Actual</h2>
                        <button id="export-consumos-button"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                            Exportar Excel
                        </button>
                    </div>
                    <div id="current-log-table-container"></div>
                </div>
            </div>

            <!-- Tipos -->
            <div id="admin-tipos-page" class="hidden">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-700 mb-4">Gestionar Tipos de Empleados</h2>

                    <div class="grid md:grid-cols-3 gap-4 mb-6">
                        <input type="text" id="new-tipo-descripcion" placeholder="Descripci√≥n del tipo"
                            class="md:col-span-2 p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="add-tipo-button"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">
                            Agregar Tipo
                        </button>
                    </div>

                    <div id="tipos-table-container" class="overflow-x-auto"></div>
                </div>
            </div>

            <!-- Comedores -->
            <div id="admin-comedores-page" class="hidden">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-bold text-gray-700 mb-4">Gestionar Comedores</h2>

                    <div class="grid md:grid-cols-4 gap-4 mb-6">
                        <input type="text" id="new-comedor-id" placeholder="ID del comedor"
                            class="p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="new-comedor-nombre" placeholder="Nombre del comedor"
                            class="p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="text" id="new-comedor-empresa" placeholder="ID de empresa"
                            class="p-3 border-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="add-comedor-button"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">
                            Agregar Comedor
                        </button>
                    </div>

                    <div id="comedores-table-container" class="overflow-x-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modales -->
    <div id="confirmation-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50"></div>
    <div id="admin-password-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50"></div>
    <div id="comedor-selector-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50"></div>

    <!-- Modal de Gafete -->
    <div id="badge-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Gafete de Empleado</h2>

            <!-- Contenedor del gafete para imprimir -->
            <div id="badge-content" class="bg-white border-4 border-gray-300 rounded-xl p-6 mb-6 text-center">
                <!-- Logo -->
                <img src="https://i.imgur.com/4SmaZVt.png" crossorigin="anonymous" alt="Logo"
                    class="mx-auto h-24 w-auto mb-4">

                <!-- QR Code -->
                <div id="badge-qr-container" class="flex justify-center mb-4">
                    <canvas id="badge-qr-canvas"></canvas>
                </div>

                <!-- Nombre del empleado -->
                <h3 id="badge-employee-name" class="text-xl font-bold text-gray-800 mb-2"></h3>
                <p id="badge-employee-number" class="text-gray-600"></p>
            </div>

            <!-- Botones de acci√≥n -->
            <div class="flex flex-col gap-3">
                <button id="print-badge-button"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </svg>
                    Imprimir Gafete
                </button>

                <button id="download-badge-button"
                    class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Descargar Imagen
                </button>

                <button id="close-badge-button"
                    class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Editar Empleado -->
    <div id="edit-employee-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Editar Empleado</h2>

            <!-- Formulario de edici√≥n -->
            <div class="space-y-4 mb-6">
                <div>
                    <label for="edit-employee-name" class="block text-gray-700 text-sm font-bold mb-2">
                        Nombre del Empleado:
                    </label>
                    <input type="text" id="edit-employee-name"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="Nombre completo">
                </div>

                <div>
                    <label for="edit-employee-number" class="block text-gray-700 text-sm font-bold mb-2">
                        N√∫mero de Empleado:
                    </label>
                    <input type="text" id="edit-employee-number"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="N√∫mero (opcional)">
                </div>

                <div>
                    <label for="edit-employee-tipo" class="block text-gray-700 text-sm font-bold mb-2">
                        Tipo de Empleado:
                    </label>
                    <select id="edit-employee-tipo"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Seleccione tipo...</option>
                    </select>
                </div>

                <input type="hidden" id="edit-employee-id">
            </div>

            <!-- Botones de acci√≥n -->
            <div class="flex gap-3">
                <button id="cancel-edit-employee-button"
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">
                    Cancelar
                </button>

                <button id="save-edit-employee-button"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                    Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Registro de PIN -->
    <div id="register-pin-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Registrar PIN</h2>
            <p class="text-gray-600 text-center mb-6">Debes registrar un PIN de 4 d√≠gitos para continuar</p>

            <div class="space-y-4 mb-6">
                <div>
                    <label for="new-pin-input" class="block text-gray-700 text-sm font-bold mb-2">
                        Ingresa tu PIN (4 d√≠gitos):
                    </label>
                    <input type="password" id="new-pin-input" maxlength="4"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg text-center text-2xl tracking-widest focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>

                <div>
                    <label for="confirm-pin-input" class="block text-gray-700 text-sm font-bold mb-2">
                        Confirma tu PIN:
                    </label>
                    <input type="password" id="confirm-pin-input" maxlength="4"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg text-center text-2xl tracking-widest focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
            </div>

            <button id="save-pin-button"
                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                Registrar PIN
            </button>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n de Identidad -->
    <div id="confirm-identity-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Confirmar Identidad</h2>
            <p class="text-xl text-gray-700 text-center mb-2">¬øEres t√∫?</p>

            <div class="bg-blue-50 rounded-lg p-4 mb-6">
                <p class="text-lg font-bold text-gray-800 text-center" id="confirm-employee-name"></p>
                <p class="text-gray-600 text-center" id="confirm-employee-number"></p>
            </div>

            <div class="flex gap-3">
                <button id="cancel-identity-button"
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">
                    Cancelar
                </button>

                <button id="accept-identity-button"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                    Aceptar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Verificaci√≥n de PIN -->
    <div id="verify-pin-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Verificar PIN</h2>
            <p class="text-gray-600 text-center mb-6">Ingresa tu PIN de 4 d√≠gitos</p>

            <div class="mb-6">
                <input type="password" id="verify-pin-input" maxlength="4"
                    class="w-full p-3 border-2 border-gray-300 rounded-lg text-center text-2xl tracking-widest focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>

            <div class="flex gap-3">
                <button id="cancel-verify-pin-button"
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">
                    Cancelar
                </button>

                <button id="verify-pin-button"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                    Verificar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Cambio de PIN (Admin) -->
    <div id="change-pin-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Modificar NIP</h2>
            <p class="text-gray-600 text-center mb-2" id="change-pin-employee-name"></p>
            <p class="text-gray-500 text-center mb-6 text-sm">Ingrese el nuevo NIP de 4 d√≠gitos</p>

            <div class="space-y-4 mb-6">
                <div>
                    <label for="admin-new-pin" class="block text-gray-700 text-sm font-bold mb-2">
                        Nuevo NIP:
                    </label>
                    <input type="password" id="admin-new-pin" maxlength="4"
                        class="w-full p-3 border-2 border-gray-300 rounded-lg text-center text-2xl tracking-widest focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
            </div>

            <input type="hidden" id="change-pin-employee-id">

            <div class="flex gap-3">
                <button id="cancel-change-pin-button"
                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">
                    Cancelar
                </button>

                <button id="save-change-pin-button"
                    class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                    Guardar
                </button>
            </div>
        </div>
    </div>

    <div id="fullscreen-message-container"
        class="hidden fixed inset-0 z-50 flex items-center justify-center text-white text-center transition-opacity duration-300">
    </div>

    <!-- JavaScript Refactorizado -->
    <script type="module">
        import * as OfflineDB from './db-offline.js';

        // ============================================================================
        // CONFIGURACI√ìN
        // ============================================================================

        // Determinar URL de la API bas√°ndose en el entorno
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1' || window.location.protocol === 'file:';
        const API_URL = isLocal ? 'http://localhost:3000/api' : '/api';

        const ADMIN_PASSWORD = '1560';

        let appState = {
            comedores: [],
            activeComedorId: null,
            empleados: [],
            consumos: [],
            tipos: [],
            currentUser: null  // Usuario autenticado
        };

        let audioStarted = false;
        let currentAdminPage = 'gestion';

        // ============================================================================
        // API
        // ============================================================================
        async function apiRequest(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_URL}${endpoint}`, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                showFullscreenMessage(false, 'Error de Conexi√≥n', error.message);
                throw error;
            }
        }

        // ============================================================================
        // AUTENTICACI√ìN
        // ============================================================================
        async function login(email, password) {
            try {
                const response = await apiRequest('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                if (response.success) {
                    appState.currentUser = response.user;

                    // Guardar en localStorage
                    localStorage.setItem('currentUser', JSON.stringify(response.user));

                    // Actualizar nombre de usuario en el badge
                    updateUserDisplay();

                    // Redirigir seg√∫n el rol
                    if (response.user.role === 'administrador') {
                        switchPage('admin-dashboard-page');
                        await loadAllData();
                    } else {
                        switchPage('main-page');
                        await loadAllData();
                    }

                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error en login:', error);
                throw error;
            }
        }

        function updateUserDisplay() {
            const userNameDisplay = document.getElementById('user-name-display');
            const comedorNameDisplay = document.getElementById('comedor-name-display');

            if (userNameDisplay && appState.currentUser) {
                userNameDisplay.textContent = appState.currentUser.fullName || appState.currentUser.email;
            }

            if (comedorNameDisplay && appState.currentUser && appState.currentUser.comedorId) {
                // Buscar el nombre del comedor
                const comedor = appState.comedores.find(c => c.comedor_id === appState.currentUser.comedorId);
                comedorNameDisplay.textContent = comedor ? comedor.comedor_nombre : appState.currentUser.comedorId;
            }
        }

        function logout() {
            appState.currentUser = null;
            localStorage.removeItem('currentUser');
            switchPage('login-page');
        }

        function checkAuth() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                appState.currentUser = JSON.parse(savedUser);
                return true;
            }
            return false;
        }

        // ============================================================================
        // CARGA DE DATOS
        // ============================================================================
        async function loadAllData() {
            try {
                // Intentar sincronizar datos offline si hay conexi√≥n
                syncOfflineData();

                // Cargar comedores
                appState.comedores = await apiRequest('/comedores');

                // Determinar el comedor activo seg√∫n el rol del usuario
                if (appState.currentUser) {
                    if (appState.currentUser.role === 'administrador') {
                        // Admin: usar el comedor seleccionado o el primero
                        if (!appState.activeComedorId && appState.comedores.length > 0) {
                            appState.activeComedorId = appState.comedores[0].comedor_id;
                        }
                    } else {
                        // Usuario no admin: usar SOLO su comedor asignado
                        if (appState.currentUser.comedorId) {
                            appState.activeComedorId = appState.currentUser.comedorId;
                        }
                    }
                } else {
                    // Sin usuario (fallback)
                    if (!appState.activeComedorId && appState.comedores.length > 0) {
                        appState.activeComedorId = appState.comedores[0].comedor_id;
                    }
                }

                // Cargar empleados del comedor activo
                if (appState.activeComedorId) {
                    appState.empleados = await apiRequest(`/empleados?comedor_id=${appState.activeComedorId}`);
                    // üíæ Guardar empleados en IndexedDB para uso offline
                    await OfflineDB.saveEmployees(appState.empleados);
                    console.log('‚úÖ Empleados guardados offline');
                }

                // Cargar tipos
                await loadTipos();

                renderAll();

                // Actualizar display del usuario (para mostrar nombre del comedor)
                updateUserDisplay();
            } catch (error) {
                console.error('Error cargando datos (posiblemente offline):', error);

                // üìÇ Intentar cargar desde IndexedDB si falla la API
                try {
                    const offlineEmployees = await OfflineDB.getEmployees();
                    if (offlineEmployees && offlineEmployees.length > 0) {
                        appState.empleados = offlineEmployees;
                        console.log('‚ö†Ô∏è Cargados empleados desde Offline DB');
                        showFullscreenMessage(true, 'Modo Offline', 'Usando datos locales');
                        renderAll();
                    }
                } catch (dbError) {
                    console.error('Error cargando IndexedDB:', dbError);
                }
            }
        }

        // ============================================================================
        // RENDERIZADO
        // ============================================================================
        function renderAll() {
            renderComedorSelector();
            renderAdminTable();
            renderComedoresTable();
            updateActiveComedorName();
        }

        function renderComedorSelector() {
            const selector = document.getElementById('admin-comedor-selector');
            if (!selector) return;

            selector.innerHTML = appState.comedores.map(c =>
                `<option value="${c.comedor_id}" ${c.comedor_id === appState.activeComedorId ? 'selected' : ''}>
                    ${c.comedor_nombre}
                </option>`
            ).join('');
        }

        function renderAdminTable(searchTerm = '') {
            const container = document.getElementById('admin-table-container');
            if (!container) return;

            const filtered = appState.empleados.filter(e =>
                !searchTerm ||
                e.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (e.number && e.number.includes(searchTerm))
            );

            container.innerHTML = `
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left">Nombre</th>
                            <th class="px-4 py-2 text-left">N√∫mero</th>
                            <th class="px-4 py-2 text-left">Tipo</th>
                            <th class="px-4 py-2 text-left">PIN</th>
                            <th class="px-4 py-2 text-left">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(emp => {
                // Buscar el tipo si tiene tipo_id
                let tipoDesc = '-';
                if (emp.tipo_id) {
                    const tipo = appState.tipos.find(t => t.id_tipo === emp.tipo_id);
                    tipoDesc = tipo ? tipo.descripcion : `ID: ${emp.tipo_id}`;
                } else if (emp.type) {
                    tipoDesc = emp.type;
                }

                return `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="px-4 py-2">${emp.name}</td>
                                <td class="px-4 py-2">${emp.number || '-'}</td>
                                <td class="px-4 py-2">${tipoDesc}</td>
                                <td class="px-4 py-2">${emp.pin ? '‚úì' : '‚úó'}</td>
                                <td class="px-4 py-2">
                                    <select onchange="handleEmployeeAction(this.value, '${emp.internal_id}', '${emp.name.replace(/'/g, "\\'")}', '${emp.number || ''}')" 
                                        class="p-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Seleccionar...</option>
                                        <option value="edit">Editar</option>
                                        <option value="change_pin">Modificar NIP</option>
                                        <option value="badge">Generar Gafete</option>
                                        <option value="delete">Eliminar</option>
                                    </select>
                                </td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;
        }

        function updateActiveComedorName() {
            const nameSpan = document.getElementById('active-comedor-name');
            if (!nameSpan) return;

            const activeComedor = appState.comedores.find(c => c.comedor_id === appState.activeComedorId);
            nameSpan.textContent = activeComedor ? activeComedor.comedor_nombre : 'Sin comedor';
        }

        async function renderConsumosTable() {
            const container = document.getElementById('current-log-table-container');
            if (!container) return;

            try {
                console.log('üîç Cargando consumos para comedor:', appState.activeComedorId);

                // Cargar consumos de la semana actual
                const consumos = await apiRequest(`/consumos/semana-actual/${appState.activeComedorId}`);

                console.log('üìä Consumos recibidos:', consumos);
                console.log('üìä Cantidad:', consumos ? consumos.length : 0);

                if (!consumos || consumos.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <p class="text-lg">No hay consumos registrados esta semana</p>
                            <p class="text-sm mt-2">Comedor ID: ${appState.activeComedorId}</p>
                        </div>
                    `;
                    return;
                }

                // Agrupar por d√≠a
                const diasSemana = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
                const consumosPorDia = {};

                consumos.forEach(c => {
                    if (!consumosPorDia[c.day_name]) {
                        consumosPorDia[c.day_name] = [];
                    }
                    consumosPorDia[c.day_name].push(c);
                });
                console.log('container1:', container);
                container.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 text-left">Empleado</th>
                                    ${diasSemana.map(dia => `<th class="px-4 py-2 text-center">${dia.substring(0, 3)}</th>`).join('')}
                                    <th class="px-4 py-2 text-center">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${generateConsumosRows(consumos, diasSemana)}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4 p-4 bg-blue-50 rounded-lg">
                        <h3 class="font-bold text-lg mb-2">Resumen Semanal</h3>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            ${diasSemana.map(dia => {
                    const consumosDia = consumosPorDia[dia] || [];
                    const total = consumosDia.reduce((sum, c) => sum + parseInt(c.consumption_count || 0), 0);
                    return `
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-blue-600">${total}</div>
                                        <div class="text-sm text-gray-600">${dia}</div>
                                    </div>
                                `;
                }).join('')}
                        </div>
                    </div>
                `;
                console.log('container1:', container);
            } catch (error) {
                console.error('Error cargando consumos:', error);
                container.innerHTML = `
                    <div class="text-center py-8 text-red-500">
                        <p class="text-lg">Error al cargar consumos</p>
                        <p class="text-sm">${error.message}</p>
                    </div>
                `;
            }
        }

        function generateConsumosRows(consumos, diasSemana) {
            // Agrupar por empleado
            const empleadosMap = {};

            consumos.forEach(c => {
                if (!empleadosMap[c.employee_id]) {
                    empleadosMap[c.employee_id] = {
                        nombre: c.employee_name || 'Desconocido',
                        consumos: {}
                    };
                }
                empleadosMap[c.employee_id].consumos[c.day_name] = parseInt(c.consumption_count || 0);
            });

            // Generar filas
            return Object.entries(empleadosMap).map(([employeeId, data]) => {
                const consumosPorDia = diasSemana.map(dia => data.consumos[dia] || 0);
                const total = consumosPorDia.reduce((sum, count) => sum + count, 0);

                return `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="px-4 py-2">${data.nombre}</td>
                        ${consumosPorDia.map(count => `
                            <td class="px-4 py-2 text-center ${count > 0 ? 'bg-green-100 font-bold' : 'text-gray-400'}">
                                ${count > 0 ? count : '-'}
                            </td>
                        `).join('')}
                        <td class="px-4 py-2 text-center font-bold text-blue-600">${total}</td>
                    </tr>
                `;
            }).join('');
        }

        // ============================================================================
        // FUNCIONES PARA TIPOS
        // ============================================================================

        async function loadTipos() {
            try {
                appState.tipos = await apiRequest('/tipos');
                renderTiposSelect();
                renderTiposTable();
            } catch (error) {
                console.error('Error cargando tipos:', error);
            }
        }

        function renderTiposSelect() {
            const select = document.getElementById('new-employee-tipo');
            if (!select) return;

            select.innerHTML = '<option value="">Seleccione tipo...</option>';
            appState.tipos.forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo.id_tipo;
                option.textContent = tipo.descripcion;
                select.appendChild(option);
            });
        }

        function renderTiposTable() {
            const container = document.getElementById('tipos-table-container');
            if (!container) return;

            if (appState.tipos.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p class="text-lg">No hay tipos registrados</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left">ID</th>
                            <th class="px-4 py-2 text-left">Descripci√≥n</th>
                            <th class="px-4 py-2 text-left">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appState.tipos.map(tipo => `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="px-4 py-2">${tipo.id_tipo}</td>
                                <td class="px-4 py-2">
                                    <span id="tipo-desc-${tipo.id_tipo}">${tipo.descripcion}</span>
                                    <input type="text" id="tipo-edit-${tipo.id_tipo}" value="${tipo.descripcion}" 
                                        class="hidden p-2 border rounded">
                                </td>
                                <td class="px-4 py-2 space-x-2">
                                    <button onclick="editTipo(${tipo.id_tipo})" id="btn-edit-${tipo.id_tipo}"
                                        class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
                                        Editar
                                    </button>
                                    <button onclick="saveTipo(${tipo.id_tipo})" id="btn-save-${tipo.id_tipo}"
                                        class="hidden bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">
                                        Guardar
                                    </button>
                                    <button onclick="cancelEditTipo(${tipo.id_tipo})" id="btn-cancel-${tipo.id_tipo}"
                                        class="hidden bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600">
                                        Cancelar
                                    </button>
                                    <button onclick="deleteTipo(${tipo.id_tipo})"
                                        class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                                        Eliminar
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        window.editTipo = function (id) {
            document.getElementById(`tipo-desc-${id}`).classList.add('hidden');
            document.getElementById(`tipo-edit-${id}`).classList.remove('hidden');
            document.getElementById(`btn-edit-${id}`).classList.add('hidden');
            document.getElementById(`btn-save-${id}`).classList.remove('hidden');
            document.getElementById(`btn-cancel-${id}`).classList.remove('hidden');
        };

        window.cancelEditTipo = function (id) {
            document.getElementById(`tipo-desc-${id}`).classList.remove('hidden');
            document.getElementById(`tipo-edit-${id}`).classList.add('hidden');
            document.getElementById(`btn-edit-${id}`).classList.remove('hidden');
            document.getElementById(`btn-save-${id}`).classList.add('hidden');
            document.getElementById(`btn-cancel-${id}`).classList.add('hidden');
        };

        window.saveTipo = async function (id) {
            const newDesc = document.getElementById(`tipo-edit-${id}`).value.trim();

            if (!newDesc) {
                alert('La descripci√≥n no puede estar vac√≠a');
                return;
            }

            try {
                await apiRequest(`/tipos/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ descripcion: newDesc })
                });

                await loadTipos();
                showFullscreenMessage(true, '√âxito', 'Tipo actualizado');
            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        };

        window.deleteTipo = async function (id) {
            if (!confirm('¬øEst√°s seguro de eliminar este tipo?')) return;

            try {
                await apiRequest(`/tipos/${id}`, { method: 'DELETE' });
                await loadTipos();
                showFullscreenMessage(true, '√âxito', 'Tipo eliminado');
            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        };

        // ============================================================================
        // FUNCIONES PARA COMEDORES
        // ============================================================================

        function renderComedoresTable() {
            const container = document.getElementById('comedores-table-container');
            if (!container) return;

            if (appState.comedores.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <p class="text-lg">No hay comedores registrados</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2 text-left">ID</th>
                            <th class="px-4 py-2 text-left">Nombre</th>
                            <th class="px-4 py-2 text-left">Empresa</th>
                            <th class="px-4 py-2 text-left">Require PIN</th>
                            <th class="px-4 py-2 text-left">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appState.comedores.map(comedor => `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="px-4 py-2">
                                    <span id="comedor-id-${comedor.comedor_id}">${comedor.comedor_id}</span>
                                </td>
                                <td class="px-4 py-2">
                                    <span id="comedor-nombre-${comedor.comedor_id}">${comedor.comedor_nombre}</span>
                                    <input type="text" id="comedor-edit-nombre-${comedor.comedor_id}" value="${comedor.comedor_nombre}" 
                                        class="hidden p-2 border rounded w-full">
                                </td>
                                <td class="px-4 py-2">${comedor.empresa_nombre || comedor.empresa_id}</td>
                                <td class="px-4 py-2">${comedor.require_pin ? '‚úì' : '‚úó'}</td>
                                <td class="px-4 py-2 space-x-2">
                                    <button onclick="editComedor('${comedor.comedor_id}')" id="btn-edit-comedor-${comedor.comedor_id}"
                                        class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
                                        Editar
                                    </button>
                                    <button onclick="saveComedor('${comedor.comedor_id}')" id="btn-save-comedor-${comedor.comedor_id}"
                                        class="hidden bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">
                                        Guardar
                                    </button>
                                    <button onclick="cancelEditComedor('${comedor.comedor_id}')" id="btn-cancel-comedor-${comedor.comedor_id}"
                                        class="hidden bg-gray-500 text-white px-3 py-1 rounded hover:bg-gray-600">
                                        Cancelar
                                    </button>
                                    <button onclick="deleteComedor('${comedor.comedor_id}')"
                                        class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                                        Eliminar
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        window.editComedor = function (id) {
            document.getElementById(`comedor-nombre-${id}`).classList.add('hidden');
            document.getElementById(`comedor-edit-nombre-${id}`).classList.remove('hidden');
            document.getElementById(`btn-edit-comedor-${id}`).classList.add('hidden');
            document.getElementById(`btn-save-comedor-${id}`).classList.remove('hidden');
            document.getElementById(`btn-cancel-comedor-${id}`).classList.remove('hidden');
        };

        window.cancelEditComedor = function (id) {
            document.getElementById(`comedor-nombre-${id}`).classList.remove('hidden');
            document.getElementById(`comedor-edit-nombre-${id}`).classList.add('hidden');
            document.getElementById(`btn-edit-comedor-${id}`).classList.remove('hidden');
            document.getElementById(`btn-save-comedor-${id}`).classList.add('hidden');
            document.getElementById(`btn-cancel-comedor-${id}`).classList.add('hidden');
        };

        window.saveComedor = async function (id) {
            const newNombre = document.getElementById(`comedor-edit-nombre-${id}`).value.trim();

            if (!newNombre) {
                alert('El nombre no puede estar vac√≠o');
                return;
            }

            try {
                await apiRequest(`/comedores/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ name: newNombre })
                });

                await loadAllData();
                showFullscreenMessage(true, '√âxito', 'Comedor actualizado');
            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        };

        window.deleteComedor = async function (id) {
            if (!confirm('¬øEst√°s seguro de eliminar este comedor? Esto puede afectar a empleados y usuarios asignados.')) return;

            try {
                await apiRequest(`/comedores/${id}`, { method: 'DELETE' });
                await loadAllData();
                showFullscreenMessage(true, '√âxito', 'Comedor eliminado');
            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        };

        // ============================================================================
        // ACCIONES
        // ============================================================================
        // Variable global para almacenar el empleado actual en proceso
        let currentEmployeeForPIN = null;

        async function registerConsumption(employeeId) {
            try {
                // Buscar el empleado completo
                const employee = appState.empleados.find(e => e.internal_id === employeeId);

                if (!employee) {
                    showFullscreenMessage(false, 'Error', 'Empleado no encontrado');
                    return;
                }

                currentEmployeeForPIN = employee;

                // Verificar si tiene PIN
                if (!employee.pin || employee.pin === null) {
                    // No tiene PIN - Mostrar modal de registro
                    showRegisterPINModal(employee);
                } else {
                    // Tiene PIN - Mostrar modal de confirmaci√≥n de identidad
                    showConfirmIdentityModal(employee);
                }

            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        }

        // ============================================================================
        // FUNCIONES DE GESTI√ìN DE PIN
        // ============================================================================

        function showRegisterPINModal(employee) {
            const modal = document.getElementById('register-pin-modal');
            modal.classList.remove('hidden');

            // Limpiar inputs
            document.getElementById('new-pin-input').value = '';
            document.getElementById('confirm-pin-input').value = '';

            // Focus en el primer input
            setTimeout(() => {
                document.getElementById('new-pin-input').focus();
            }, 100);
        }

        function showConfirmIdentityModal(employee) {
            const modal = document.getElementById('confirm-identity-modal');
            modal.classList.remove('hidden');

            // Mostrar datos del empleado
            document.getElementById('confirm-employee-name').textContent = employee.name;
            document.getElementById('confirm-employee-number').textContent = `#${employee.number || employee.internal_id}`;
        }

        function showVerifyPINModal() {
            // Cerrar modal de confirmaci√≥n
            document.getElementById('confirm-identity-modal').classList.add('hidden');

            // Abrir modal de verificaci√≥n
            const modal = document.getElementById('verify-pin-modal');
            modal.classList.remove('hidden');

            // Limpiar input
            document.getElementById('verify-pin-input').value = '';

            // Focus en el input
            setTimeout(() => {
                document.getElementById('verify-pin-input').focus();
            }, 100);
        }

        async function completePINRegistration() {
            const newPIN = document.getElementById('new-pin-input').value;
            const confirmPIN = document.getElementById('confirm-pin-input').value;

            // Validaciones
            if (!newPIN || newPIN.length !== 4) {
                alert('El PIN debe tener 4 d√≠gitos');
                return;
            }

            if (!/^\d{4}$/.test(newPIN)) {
                alert('El PIN debe contener solo n√∫meros');
                return;
            }

            if (newPIN !== confirmPIN) {
                alert('Los PINs no coinciden');
                return;
            }

            try {
                // Actualizar el PIN del empleado
                await apiRequest(`/empleados/${currentEmployeeForPIN.internal_id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ pin: newPIN })
                });

                // ‚úÖ Actualizar estado local inmediatamente
                currentEmployeeForPIN.pin = newPIN;
                const localEmp = appState.empleados.find(e => e.internal_id === currentEmployeeForPIN.internal_id);
                if (localEmp) localEmp.pin = newPIN;

                // üíæ Actualizar cache offline
                await OfflineDB.updateEmployeePIN(currentEmployeeForPIN.internal_id, newPIN);
                console.log('‚úÖ Local state and offline cache updated for PIN');

                // Cerrar modal
                document.getElementById('register-pin-modal').classList.add('hidden');

                // Registrar consumo directamente
                await completeConsumptionRegistration();

            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        }

        async function verifyPINAndRegister() {
            const enteredPIN = document.getElementById('verify-pin-input').value;

            if (!enteredPIN || enteredPIN.length !== 4) {
                alert('Debes ingresar un PIN de 4 d√≠gitos');
                return;
            }

            // Verificar PIN
            if (enteredPIN === currentEmployeeForPIN.pin) {
                // PIN correcto
                document.getElementById('verify-pin-modal').classList.add('hidden');
                await completeConsumptionRegistration();
            } else {
                // PIN incorrecto
                document.getElementById('verify-pin-modal').classList.add('hidden');
                showFullscreenMessage(false, 'PIN Incorrecto', 'El PIN ingresado no es v√°lido');

                // Limpiar despu√©s de 2 segundos
                setTimeout(() => {
                    document.getElementById('employeeSearch').value = '';
                    document.getElementById('search-results-container').classList.add('hidden');
                    currentEmployeeForPIN = null;
                }, 2000);
            }
        }

        async function completeConsumptionRegistration() {
            const consumptionData = {
                employee_id: currentEmployeeForPIN.internal_id,
                comedor_id: appState.activeComedorId,
                consumption_date: new Date().toISOString().split('T')[0]
            };

            try {
                await apiRequest('/consumos', {
                    method: 'POST',
                    body: JSON.stringify(consumptionData)
                });

                showFullscreenMessage(true, '¬°Validado!', 'Consumo registrado exitosamente');
                resetSearch();

            } catch (error) {
                console.error('Error registro online:', error);
                // üîå Fallback Offline
                try {
                    await OfflineDB.saveConsumption(consumptionData);
                    showFullscreenMessage(true, 'Guardado Offline', 'Consumo guardado localmente');
                    resetSearch();
                } catch (dbError) {
                    showFullscreenMessage(false, 'Error Fatal', 'No se pudo guardar ni online ni offline');
                }
            }
        }

        function resetSearch() {
            setTimeout(() => {
                document.getElementById('employeeSearch').value = '';
                document.getElementById('search-results-container').classList.add('hidden');
                currentEmployeeForPIN = null;
            }, 2000);
        }

        async function syncOfflineData() {
            if (!navigator.onLine) return;

            try {
                const pending = await OfflineDB.getPendingConsumptions();
                if (pending.length === 0) return;

                console.log(`üì° Sincronizando ${pending.length} consumos offline...`);
                let syncedCount = 0;

                for (const item of pending) {
                    try {
                        await apiRequest('/consumos', {
                            method: 'POST',
                            body: JSON.stringify({
                                employee_id: item.employee_id,
                                comedor_id: item.comedor_id,
                                consumption_date: item.consumption_date
                            })
                        });
                        // Si tiene √©xito, borrar de IDB
                        await OfflineDB.deleteConsumption(item.id);
                        syncedCount++;
                    } catch (err) {
                        console.error('Error sincronizando item:', item, err);
                    }
                }

                if (syncedCount > 0) {
                    console.log(`‚úÖ Sincronizados ${syncedCount}/${pending.length} consumos`);
                    showFullscreenMessage(true, 'Sincronizaci√≥n', `${syncedCount} consumos subidos`);
                    // Recargar tabla de consumos actual
                    renderConsumosTable();
                }
            } catch (error) {
                console.error('Error en sync:', error);
            }
        }

        // Listener para cuando vuelve internet
        window.addEventListener('online', syncOfflineData);

        // Event Listeners para los modales de PIN
        document.getElementById('save-pin-button')?.addEventListener('click', completePINRegistration);

        document.getElementById('cancel-identity-button')?.addEventListener('click', () => {
            document.getElementById('confirm-identity-modal').classList.add('hidden');
            document.getElementById('employeeSearch').value = '';
            document.getElementById('search-results-container').classList.add('hidden');
            currentEmployeeForPIN = null;
        });

        document.getElementById('accept-identity-button')?.addEventListener('click', () => {
            showVerifyPINModal();
        });

        document.getElementById('cancel-verify-pin-button')?.addEventListener('click', () => {
            document.getElementById('verify-pin-modal').classList.add('hidden');
            document.getElementById('employeeSearch').value = '';
            document.getElementById('search-results-container').classList.add('hidden');
            currentEmployeeForPIN = null;
        });

        document.getElementById('verify-pin-button')?.addEventListener('click', verifyPINAndRegister);

        // Permitir Enter en los inputs de PIN
        document.getElementById('new-pin-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('confirm-pin-input').focus();
            }
        });

        document.getElementById('confirm-pin-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                completePINRegistration();
            }
        });

        document.getElementById('verify-pin-input')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                verifyPINAndRegister();
            }
        });

        // ============================================================================
        // GESTI√ìN DE ACCIONES DE EMPLEADOS
        // ============================================================================

        window.handleEmployeeAction = function (action, employeeId, employeeName, employeeNumber) {
            // Resetear el select
            event.target.value = '';

            switch (action) {
                case 'edit':
                    editEmployee(employeeId, employeeName, employeeNumber);
                    break;
                case 'change_pin':
                    openChangePinModal(employeeId, employeeName);
                    break;
                case 'badge':
                    generateBadge(employeeId, employeeName, employeeNumber);
                    break;
                case 'delete':
                    deleteEmployee(employeeId);
                    break;
            }
        };

        function openChangePinModal(employeeId, employeeName) {
            const modal = document.getElementById('change-pin-modal');
            modal.classList.remove('hidden');

            document.getElementById('change-pin-employee-name').textContent = employeeName;
            document.getElementById('change-pin-employee-id').value = employeeId;
            document.getElementById('admin-new-pin').value = '';

            setTimeout(() => {
                document.getElementById('admin-new-pin').focus();
            }, 100);
        }

        // Event listeners para el modal de cambio de PIN (Admin)
        document.getElementById('cancel-change-pin-button')?.addEventListener('click', () => {
            document.getElementById('change-pin-modal').classList.add('hidden');
        });

        document.getElementById('save-change-pin-button')?.addEventListener('click', async () => {
            const employeeId = document.getElementById('change-pin-employee-id').value;
            const newPin = document.getElementById('admin-new-pin').value;

            if (!newPin || newPin.length !== 4 || !/^\d{4}$/.test(newPin)) {
                alert('El NIP debe ser de 4 d√≠gitos num√©ricos');
                return;
            }

            try {
                await apiRequest(`/empleados/${employeeId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ pin: newPin })
                });

                document.getElementById('change-pin-modal').classList.add('hidden');
                await loadAllData();
                showFullscreenMessage(true, '√âxito', 'NIP actualizado correctamente');
            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        });

        function editEmployee(employeeId, employeeName, employeeNumber) {
            // Buscar el empleado completo en el estado
            const employee = appState.empleados.find(e => e.internal_id === employeeId);

            if (!employee) {
                alert('Empleado no encontrado');
                return;
            }

            // Mostrar modal
            const modal = document.getElementById('edit-employee-modal');
            modal.classList.remove('hidden');

            // Cargar datos en el formulario
            document.getElementById('edit-employee-id').value = employeeId;
            document.getElementById('edit-employee-name').value = employee.name;
            document.getElementById('edit-employee-number').value = employee.number || '';

            // Cargar tipos en el select
            const tipoSelect = document.getElementById('edit-employee-tipo');
            tipoSelect.innerHTML = '<option value="">Sin tipo</option>';
            appState.tipos.forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo.id_tipo;
                option.textContent = tipo.descripcion;
                option.selected = employee.tipo_id === tipo.id_tipo;
                tipoSelect.appendChild(option);
            });
        }

        // Event listeners para el modal de edici√≥n
        document.getElementById('cancel-edit-employee-button')?.addEventListener('click', () => {
            document.getElementById('edit-employee-modal').classList.add('hidden');
        });

        document.getElementById('save-edit-employee-button')?.addEventListener('click', async () => {
            const employeeId = document.getElementById('edit-employee-id').value;
            const name = document.getElementById('edit-employee-name').value.trim();
            const number = document.getElementById('edit-employee-number').value.trim();
            const tipoId = document.getElementById('edit-employee-tipo').value;

            if (!name) {
                alert('El nombre es obligatorio');
                return;
            }

            try {
                // Preparar datos para actualizar
                const updateData = {
                    name: name
                };

                if (number) {
                    updateData.number = number;
                }

                if (tipoId) {
                    updateData.tipo_id = tipoId;
                }

                // Llamar al API para actualizar
                await apiRequest(`/empleados/${employeeId}`, {
                    method: 'PUT',
                    body: JSON.stringify(updateData)
                });

                // Cerrar modal
                document.getElementById('edit-employee-modal').classList.add('hidden');

                // Recargar datos
                await loadAllData();

                showFullscreenMessage(true, '√âxito', 'Empleado actualizado');
            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        });

        function generateBadge(employeeId, employeeName, employeeNumber) {
            // Mostrar modal
            const modal = document.getElementById('badge-modal');
            modal.classList.remove('hidden');

            // Actualizar nombre y n√∫mero
            document.getElementById('badge-employee-name').textContent = employeeName;
            document.getElementById('badge-employee-number').textContent = employeeNumber ? `#${employeeNumber}` : 'Sin n√∫mero';

            // Generar QR Code
            const qrContainer = document.getElementById('badge-qr-container');
            qrContainer.innerHTML = '';

            const qrData = employeeNumber || employeeId;

            // Usar la librer√≠a QRCode (window.QRCode de qrcode.min.js)
            if (window.QRCode && window.QRCode.toCanvas) {
                const canvas = document.createElement('canvas');
                qrContainer.appendChild(canvas);

                window.QRCode.toCanvas(canvas, qrData, {
                    width: 200,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                }, function (error) {
                    if (error) console.error('Error generando QR:', error);
                });
            } else {
                // Fallback: usar QRCode constructor (de qrcodejs)
                new QRCode(qrContainer, {
                    text: qrData,
                    width: 200,
                    height: 200,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        }

        // Event listeners para el modal de gafete
        document.getElementById('close-badge-button')?.addEventListener('click', () => {
            document.getElementById('badge-modal').classList.add('hidden');
        });

        document.getElementById('print-badge-button')?.addEventListener('click', () => {
            printBadge();
        });

        document.getElementById('download-badge-button')?.addEventListener('click', () => {
            downloadBadge();
        });

        function printBadge() {
            const badgeContent = document.getElementById('badge-content');
            const printWindow = window.open('', '_blank');

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Gafete de Empleado</title>
                    <style>
                        body {
                            margin: 0;
                            padding: 20px;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            min-height: 100vh;
                        }
                        .badge {
                            border: 4px solid #ccc;
                            border-radius: 12px;
                            padding: 24px;
                            text-align: center;
                            max-width: 400px;
                        }
                        img {
                            max-height: 96px;
                            margin-bottom: 16px;
                        }
                        canvas {
                            margin: 16px 0;
                        }
                        h3 {
                            font-size: 24px;
                            font-weight: bold;
                            margin: 8px 0;
                        }
                        p {
                            color: #666;
                            margin: 0;
                        }
                        @media print {
                            body {
                                padding: 0;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="badge">
                        ${badgeContent.innerHTML}
                    </div>
                    <script>
                        window.onload = function() {
                            window.print();
                            window.onafterprint = function() {
                                window.close();
                            };
                        };
                    <\/script>
</body>

</html>
`);

            printWindow.document.close();
        }

        async function downloadBadge() {
            const badgeContent = document.getElementById('badge-content');

            try {
                // Usar html2canvas para convertir el div a imagen
                const canvas = await html2canvas(badgeContent, {
                    backgroundColor: '#ffffff',
                    scale: 2
                });

                // Convertir canvas a blob
                canvas.toBlob(function (blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const employeeName = document.getElementById('badge-employee-name').textContent;
                    link.download = `gafete-${employeeName.replace(/\s+/g, '-')}.png`;
                    link.href = url;
                    link.click();
                    URL.revokeObjectURL(url);
                });
            } catch (error) {
                console.error('Error descargando gafete:', error);
                alert('Error al descargar el gafete. Intenta usar el bot√≥n de imprimir.');
            }
        }

        window.deleteEmployee = async function (employeeId) {
            if (!confirm('¬øEst√°s seguro de eliminar este empleado?')) return;

            try {
                await apiRequest(`/empleados/${employeeId}`, { method: 'DELETE' });
                await loadAllData();
                showFullscreenMessage(true, '√âxito', 'Empleado eliminado');
            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        };

        // ============================================================================
        // UTILIDADES
        // ============================================================================
        // ============================================================================
        // SONIDOS
        // ============================================================================
        async function playSuccessSound() {
            try {
                await Tone.start();
                const synth = new Tone.Synth().toDestination();
                const now = Tone.now();
                // Arpegio ascendente feliz (Do-Mi-Sol)
                synth.triggerAttackRelease("C5", "16n", now);
                synth.triggerAttackRelease("E5", "16n", now + 0.1);
                synth.triggerAttackRelease("G5", "8n", now + 0.2);
            } catch (error) {
                console.log('Error reproduciendo sonido:', error);
            }
        }

        async function playErrorSound() {
            try {
                await Tone.start();
                const synth = new Tone.Synth({
                    oscillator: { type: "sawtooth" },
                    envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.2 }
                }).toDestination();
                const now = Tone.now();
                // Dos tonos graves y disonantes
                synth.triggerAttackRelease("G2", "8n", now);
                synth.triggerAttackRelease("C2", "4n", now + 0.15);
            } catch (error) {
                console.log('Error reproduciendo sonido:', error);
            }
        }

        function showFullscreenMessage(isSuccess, title, message) {
            // Reproducir sonido correspondiente
            if (isSuccess) {
                playSuccessSound();
            } else {
                playErrorSound();
            }

            const container = document.getElementById('fullscreen-message-container');
            container.className = `fixed inset-0 z-[100] flex items-center justify-center text-white text-center transition-opacity duration-300 ${isSuccess ? 'bg-green-500' : 'bg-red-600'}`;
            container.innerHTML = `
                <div class="flex flex-col items-center p-4">
                    <h2 class="text-4xl font-bold mb-4">${title}</h2>
                    <p class="text-xl">${message}</p>
                </div>
            `;
            container.classList.remove('hidden');
            setTimeout(() => container.classList.add('hidden'), 3000);
        }

        function switchPage(pageId) {
            document.querySelectorAll('.page-container').forEach(p => p.classList.add('hidden'));
            document.getElementById(pageId)?.classList.remove('hidden');
        }

        // ============================================================================
        // EVENT LISTENERS
        // ============================================================================
        document.getElementById('logout-button')?.addEventListener('click', () => {
            if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
                logout();
            }
        });

        // Logout button para la p√°gina principal (usuarios no admin)
        document.getElementById('logout-button-main')?.addEventListener('click', () => {
            if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
                logout();
            }
        });

        document.getElementById('admin-comedor-selector')?.addEventListener('change', async (e) => {
            appState.activeComedorId = e.target.value;
            await loadAllData();
        });

        document.getElementById('add-employee-button')?.addEventListener('click', async () => {
            const number = document.getElementById('new-employee-id').value;
            const name = document.getElementById('new-employee-name').value;
            const tipoId = document.getElementById('new-employee-tipo').value;

            if (!name) {
                alert('El nombre es obligatorio');
                return;
            }

            // Validar que si no hay n√∫mero, debe haber tipo
            if (!number && !tipoId) {
                alert('Debe ingresar un n√∫mero o seleccionar un tipo');
                return;
            }

            try {
                await apiRequest('/empleados', {
                    method: 'POST',
                    body: JSON.stringify({
                        internal_id: crypto.randomUUID(),
                        comedor_id: appState.activeComedorId,
                        name: name,
                        number: number || null,
                        tipo_id: tipoId || null
                    })
                });

                document.getElementById('new-employee-id').value = '';
                document.getElementById('new-employee-name').value = '';
                document.getElementById('new-employee-tipo').value = '';
                await loadAllData();
                showFullscreenMessage(true, '√âxito', 'Empleado agregado');
            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        });

        document.getElementById('admin-employee-search')?.addEventListener('input', (e) => {
            renderAdminTable(e.target.value);
        });

        document.getElementById('employeeSearch')?.addEventListener('input', async (e) => {
            const searchTerm = e.target.value.trim();
            const resultsContainer = document.getElementById('search-results-container');

            if (searchTerm.length < 2) { resultsContainer.classList.add('hidden'); return; } const
                filtered = appState.empleados.filter(emp =>
                    emp.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (emp.number && emp.number.includes(searchTerm))
                );

            if (filtered.length > 0) {
                resultsContainer.innerHTML = filtered.map(emp => `
    <div class="p-3 hover:bg-gray-100 cursor-pointer border-b" onclick="selectEmployee('${emp.internal_id}')">
        <div class="font-bold">${emp.name}</div>
        <div class="text-sm text-gray-600">${emp.number || 'Sin n√∫mero'}</div>
    </div>
    `).join('');
                resultsContainer.classList.remove('hidden');
            } else {
                resultsContainer.classList.add('hidden');
            }
        });

        window.selectEmployee = function (employeeId) {
            const employee = appState.empleados.find(e => e.internal_id === employeeId);
            if (employee) {
                registerConsumption(employeeId);
            }
        };

        // Event listener para habilitar/deshabilitar select de tipo
        document.getElementById('new-employee-id')?.addEventListener('input', (e) => {
            const tipoSelect = document.getElementById('new-employee-tipo');
            if (!tipoSelect) return;

            if (e.target.value.trim()) {
                // Si hay n√∫mero, deshabilitar tipo
                tipoSelect.disabled = true;
                tipoSelect.classList.add('bg-gray-100');
                tipoSelect.value = '';
            } else {
                // Si no hay n√∫mero, habilitar tipo
                tipoSelect.disabled = false;
                tipoSelect.classList.remove('bg-gray-100');
            }
        });

        // Event listener para agregar tipo
        document.getElementById('add-tipo-button')?.addEventListener('click', async () => {
            const descripcion = document.getElementById('new-tipo-descripcion').value.trim();

            if (!descripcion) {
                alert('La descripci√≥n es obligatoria');
                return;
            }

            try {
                await apiRequest('/tipos', {
                    method: 'POST',
                    body: JSON.stringify({ descripcion })
                });

                document.getElementById('new-tipo-descripcion').value = '';
                await loadTipos();
                showFullscreenMessage(true, '√âxito', 'Tipo agregado');
            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        });

        // Event listener para agregar comedor
        document.getElementById('add-comedor-button')?.addEventListener('click', async () => {
            const id = document.getElementById('new-comedor-id').value.trim();
            const nombre = document.getElementById('new-comedor-nombre').value.trim();
            const empresaId = document.getElementById('new-comedor-empresa').value.trim();

            if (!id || !nombre || !empresaId) {
                alert('Todos los campos son obligatorios');
                return;
            }

            try {
                await apiRequest('/comedores', {
                    method: 'POST',
                    body: JSON.stringify({
                        id: id,
                        name: nombre,
                        empresa_id: empresaId,
                        require_pin: true
                    })
                });

                document.getElementById('new-comedor-id').value = '';
                document.getElementById('new-comedor-nombre').value = '';
                document.getElementById('new-comedor-empresa').value = '';
                await loadAllData();
                renderComedoresTable();
                showFullscreenMessage(true, '√âxito', 'Comedor agregado');
            } catch (error) {
                showFullscreenMessage(false, 'Error', error.message);
            }
        });




        // Tabs de admin
        document.querySelectorAll('.admin-nav-button').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const page = e.target.dataset.adminPage;
                currentAdminPage = page;

                console.log('üîÑ Cambiando a pesta√±a:', page);

                // Actualizar tabs
                document.querySelectorAll('.admin-nav-button').forEach(b => {
                    b.classList.remove('text-blue-600', 'border-blue-600', 'border-b-2');
                    b.classList.add('text-gray-500');
                });
                e.target.classList.add('text-blue-600', 'border-blue-600', 'border-b-2');
                e.target.classList.remove('text-gray-500');

                // Ocultar todas las p√°ginas admin
                document.getElementById('admin-gestion-page')?.classList.add('hidden');
                document.getElementById('admin-consumos-page')?.classList.add('hidden');
                document.getElementById('admin-tipos-page')?.classList.add('hidden');
                document.getElementById('admin-comedores-page')?.classList.add('hidden');

                // Mostrar la p√°gina seleccionada
                const targetPage = document.getElementById(`admin-${page}-page`);
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                    console.log('‚úÖ P√°gina mostrada:', `admin-${page}-page`);
                } else {
                    console.error('‚ùå P√°gina no encontrada:', `admin-${page}-page`);
                }

                // Cargar datos espec√≠ficos de la p√°gina
                if (page === 'consumos') {
                    console.log('üîÑ Recargando consumos...');
                    await renderConsumosTable();
                } else if (page === 'tipos') {
                    console.log('üîÑ Recargando tipos...');
                    await loadTipos();
                }
            });
        });

        // ============================================================================
        // EVENT LISTENER - LOGIN
        // ============================================================================
        document.getElementById('login-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');

            errorDiv.classList.add('hidden');

            try {
                await login(email, password);
            } catch (error) {
                errorDiv.textContent = error.message || 'Credenciales inv√°lidas';
                errorDiv.classList.remove('hidden');
            }
        });

        // Exportar Consumos
        document.getElementById('export-consumos-button')?.addEventListener('click', async () => {
            try {
                // Obtener datos frescos
                const consumos = await apiRequest(`/consumos/semana-actual/${appState.activeComedorId}`);

                if (!consumos || consumos.length === 0) {
                    alert('No hay datos para exportar');
                    return;
                }

                // Transformar datos para Excel
                const dataToExport = consumos.map(c => ({
                    'Empleado ID': c.employee_id,
                    'Nombre': c.employee_name,
                    'Fecha Consumo': new Date(c.consumption_date).toLocaleDateString(),
                    'D√≠a': c.day_name,
                    'Cantidad': c.consumption_count,
                    'Comedor': c.comedor_name
                }));

                const worksheet = XLSX.utils.json_to_sheet(dataToExport);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Consumos");

                const dateStr = new Date().toISOString().split('T')[0];
                XLSX.writeFile(workbook, `Consumos_${dateStr}.xlsx`);

            } catch (error) {
                console.error('Error exportando:', error);
                alert('Error al exportar: ' + error.message);
            }
        });

        // Importar Empleados
        document.getElementById('import-employees-file')?.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 }); // Header 1 means array of arrays

                // Asumimos formato: [ [Numero, Nombre], [123, Juan], ... ]
                // O header key: [ {Numero: 123, Nombre: Juan}, ... ]
                // Vamos a intentar detectar headers o usar indices 0 y 1.

                // Mejor usar json auto key si tienen headers
                const jsonDataObjects = XLSX.utils.sheet_to_json(firstSheet);

                let processedCount = 0;
                let skippedCount = 0;
                let errorCount = 0;

                console.log('Datos importados:', jsonDataObjects);

                // Normalizar keys
                const employeesToProcess = jsonDataObjects.map(row => {
                    // Buscar key que parezca numero y nombre
                    const activeKeys = Object.keys(row);
                    const numberKey = activeKeys.find(k => k.toLowerCase().includes('numero') || k.toLowerCase().includes('emp') || k.toLowerCase().includes('id'));
                    const nameKey = activeKeys.find(k => k.toLowerCase().includes('nombre') || k.toLowerCase().includes('name'));

                    if (numberKey && nameKey) {
                        return { number: String(row[numberKey]).trim(), name: String(row[nameKey]).trim() };
                    }
                    return null;
                }).filter(x => x !== null);

                if (employeesToProcess.length === 0) {
                    alert('No se detectaron columnas v√°lidas. Use cabeceras "NumeroEmpleado" y "NombreCompleto".');
                    return;
                }

                showFullscreenMessage(true, 'Procesando...', `Importando ${employeesToProcess.length} empleados...`);

                for (const emp of employeesToProcess) {
                    // Validar duplicado localmente primero para ahorrar request
                    const exists = appState.empleados.some(e => e.number === emp.number);
                    if (exists) {
                        console.warn(`Duplicado omitido: ${emp.number} - ${emp.name}`);
                        skippedCount++;
                        continue;
                    }

                    try {
                        await apiRequest('/empleados', {
                            method: 'POST',
                            body: JSON.stringify({
                                internal_id: crypto.randomUUID(),
                                comedor_id: appState.activeComedorId,
                                name: emp.name,
                                number: emp.number,
                                type: 'General' // Default type
                            })
                        });
                        processedCount++;
                    } catch (err) {
                        console.error('Error guardando empleado importado:', err);
                        errorCount++;
                    }
                }

                e.target.value = ''; // Reset input
                await loadAllData();
                alert(`Importaci√≥n completada:\n‚úÖ Agregados: ${processedCount}\n‚è≠Ô∏è Duplicados (omitidos): ${skippedCount}\n‚ùå Errores: ${errorCount}`);

            } catch (error) {
                console.error('Error procesando archivo:', error);
                alert('Error al procesar archivo: ' + error.message);
                e.target.value = '';
            }
        });

        // ============================================================================
        // LISTENER GLOBAL PARA ESC√ÅNER QR (KEYBOARD WEDGE)
        // ============================================================================
        let qrBuffer = '';
        let lastKeyTime = Date.now();

        window.addEventListener('keydown', (e) => {
            // Ignorar si estamos en un input (excepto el de b√∫squeda)
            const activeElem = document.activeElement;
            const isInput = activeElem.tagName === 'INPUT' || activeElem.tagName === 'TEXTAREA';

            if (isInput && activeElem.id !== 'employeeSearch') {
                return;
            }

            const currentTime = Date.now();

            // Si ha pasado mucho tiempo entre teclas, reiniciar buffer 
            // Esto ayuda a distinguir entre esc√°ner (veloz) y teclado manual lento
            if (currentTime - lastKeyTime > 100) {
                qrBuffer = '';
            }

            lastKeyTime = currentTime;

            if (e.key === 'Enter') {
                if (qrBuffer.length > 0) {
                    console.log('üì° QR detectado globalmente:', qrBuffer);
                    const searchInput = document.getElementById('employeeSearch');
                    if (searchInput) {
                        searchInput.value = qrBuffer;
                        // Intentar buscar al empleado inmediatamente
                        selectEmployeeByData(qrBuffer);
                    }
                    qrBuffer = '';
                    e.preventDefault();
                }
            } else if (e.key.length === 1) {
                qrBuffer += e.key;

                // Si no estamos en el input, mostrar visualmente que estamos capturando
                if (activeElem.id !== 'employeeSearch') {
                    const searchInput = document.getElementById('employeeSearch');
                    if (searchInput) {
                        searchInput.value = qrBuffer;
                    }
                }
            }
        });

        // Nueva funci√≥n auxiliar para buscar empleado por ID o N√∫mero exacto
        async function selectEmployeeByData(data) {
            // Buscar en el estado local por number o internal_id
            const employee = appState.empleados.find(e =>
                (e.number && e.number === data) ||
                (e.internal_id === data)
            );

            if (employee) {
                registerConsumption(employee.internal_id);
            } else {
                console.warn('Empleado no encontrado con datos QR:', data);
                // Si no se encuentra exacto, el usuario ya ve lo que se escribi√≥ en el input
                // y puede usar los resultados de b√∫squeda normales que se disparan por el input event
            }
        }

        // ============================================================================
        // INICIALIZACI√ìN
        // ============================================================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Sistema de Comedor - PostgreSQL');
            console.log('üì° API:', API_URL);

            // Inicializar BD Offline
            try {
                await OfflineDB.initDB();
            } catch (e) {
                console.error('Error inicializando OfflineDB', e);
            }

            // Ocultar loading overlay
            document.getElementById('loading-overlay').style.display = 'none';

            // Verificar si hay sesi√≥n guardada
            if (checkAuth()) {
                console.log('‚úÖ Usuario autenticado:', appState.currentUser);

                // Actualizar nombre de usuario
                updateUserDisplay();

                // Cargar datos
                await loadAllData();

                // Mostrar p√°gina seg√∫n rol
                if (appState.currentUser.role === 'administrador') {
                    switchPage('admin-dashboard-page');
                } else {
                    switchPage('main-page');
                }

                // Auto-refresh cada 10 segundos
                setInterval(loadAllData, 10000);
            } else {
                console.log('‚ùå No hay sesi√≥n activa');
                switchPage('login-page');
            }
        });
    </script>
</body>

</html>